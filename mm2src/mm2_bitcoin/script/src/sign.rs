//! Transaction signer

use blake2b_simd::Params as Blake2b;
use bytes::Bytes;
use chain::{JoinSplit, OutPoint, ShieldedOutput, ShieldedSpend, Transaction, TransactionInput, TransactionOutput,
            TxHashAlgo};
use crypto::{dhash256, sha256};
use hash::{H256, H512};
use keys::KeyPair;
use ser::Stream;
use serde::Deserialize;
use {Builder, Script};

const ZCASH_PREVOUTS_HASH_PERSONALIZATION: &[u8] = b"ZcashPrevoutHash";
const ZCASH_SEQUENCE_HASH_PERSONALIZATION: &[u8] = b"ZcashSequencHash";
const ZCASH_OUTPUTS_HASH_PERSONALIZATION: &[u8] = b"ZcashOutputsHash";
const ZCASH_JOIN_SPLITS_HASH_PERSONALIZATION: &[u8] = b"ZcashJSplitsHash";
const ZCASH_SHIELDED_SPENDS_HASH_PERSONALIZATION: &[u8] = b"ZcashSSpendsHash";
const ZCASH_SHIELDED_OUTPUTS_HASH_PERSONALIZATION: &[u8] = b"ZcashSOutputHash";
const ZCASH_SIG_HASH_PERSONALIZATION: &[u8] = b"ZcashSigHash";

#[derive(Debug, PartialEq, Clone, Copy, Deserialize)]
pub enum SignatureVersion {
    #[serde(rename = "base")]
    Base,
    #[serde(rename = "witness_v0")]
    WitnessV0,
    #[serde(rename = "fork_id")]
    ForkId,
}

#[derive(Debug, PartialEq, Clone, Copy)]
#[repr(u8)]
pub enum SighashBase {
    All = 1,
    None = 2,
    Single = 3,
}

impl From<SighashBase> for u32 {
    fn from(s: SighashBase) -> Self { s as u32 }
}

#[cfg_attr(feature = "cargo-clippy", allow(clippy::doc_markdown))]
/// Signature hash type. [Documentation](https://en.bitcoin.it/wiki/OP_CHECKSIG#Procedure_for_Hashtype_SIGHASH_SINGLE)
#[derive(Debug, PartialEq, Clone, Copy)]
pub struct Sighash {
    pub base: SighashBase,
    pub anyone_can_pay: bool,
    pub fork_id: bool,
}

impl From<Sighash> for u32 {
    fn from(s: Sighash) -> Self {
        let base = s.base as u32;
        let base = if s.anyone_can_pay { base | 0x80 } else { base };

        if s.fork_id {
            base | 0x40
        } else {
            base
        }
    }
}

impl Sighash {
    pub fn new(base: SighashBase, anyone_can_pay: bool, fork_id: bool) -> Self {
        Sighash {
            base,
            anyone_can_pay,
            fork_id,
        }
    }

    /// Used by SCRIPT_VERIFY_STRICTENC
    pub fn is_defined(version: SignatureVersion, u: u32) -> bool {
        // reset anyone_can_pay && fork_id (if applicable) bits
        let u = match version {
            SignatureVersion::ForkId => u & !(0x40 | 0x80),
            _ => u & !(0x80),
        };

        // Only exact All | None | Single values are passing this check
        matches!(u, 1 | 2 | 3)
    }

    /// Creates Sighash from any u, even if is_defined() == false
    pub fn from_u32(version: SignatureVersion, u: u32) -> Self {
        let anyone_can_pay = (u & 0x80) == 0x80;
        let fork_id = version == SignatureVersion::ForkId && (u & 0x40) == 0x40;
        let base = match u & 0x1f {
            2 => SighashBase::None,
            3 => SighashBase::Single,
            _ => SighashBase::All,
        };

        Sighash::new(base, anyone_can_pay, fork_id)
    }
}

#[derive(Clone, Debug)]
pub struct UnsignedTransactionInput {
    pub previous_output: OutPoint,
    pub sequence: u32,
    pub amount: u64,
    pub witness: Vec<Vec<u8>>,
}

/// Used for resigning and loading test transactions
impl From<TransactionInput> for UnsignedTransactionInput {
    fn from(i: TransactionInput) -> Self {
        UnsignedTransactionInput {
            previous_output: i.previous_output,
            sequence: i.sequence,
            amount: 0,
            witness: i.script_witness.into_iter().map(Vec::from).collect(),
        }
    }
}

#[allow(clippy::upper_case_acronyms)]
#[derive(Clone, Copy, Debug)]
pub enum SignerHashAlgo {
    SHA256,
    DSHA256,
}

impl From<TxHashAlgo> for SignerHashAlgo {
    fn from(tx_hash: TxHashAlgo) -> SignerHashAlgo {
        match tx_hash {
            TxHashAlgo::DSHA256 => SignerHashAlgo::DSHA256,
            TxHashAlgo::SHA256 => SignerHashAlgo::SHA256,
        }
    }
}

impl From<SignerHashAlgo> for TxHashAlgo {
    fn from(algo: SignerHashAlgo) -> Self {
        match algo {
            SignerHashAlgo::DSHA256 => TxHashAlgo::DSHA256,
            SignerHashAlgo::SHA256 => TxHashAlgo::SHA256,
        }
    }
}

#[derive(Clone, Debug)]
pub struct TransactionInputSigner {
    pub version: i32,
    pub n_time: Option<u32>,
    pub overwintered: bool,
    pub version_group_id: u32,
    pub consensus_branch_id: u32,
    pub expiry_height: u32,
    pub value_balance: i64,
    pub inputs: Vec<UnsignedTransactionInput>,
    pub outputs: Vec<TransactionOutput>,
    pub lock_time: u32,
    pub join_splits: Vec<JoinSplit>,
    pub shielded_spends: Vec<ShieldedSpend>,
    pub shielded_outputs: Vec<ShieldedOutput>,
    pub zcash: bool,
    pub posv: bool,
    pub str_d_zeel: Option<String>,
    pub hash_algo: SignerHashAlgo,
}

/// Used for resigning and loading test transactions
impl From<Transaction> for TransactionInputSigner {
    fn from(t: Transaction) -> Self {
        TransactionInputSigner {
            version: t.version,
            n_time: t.n_time,
            overwintered: t.overwintered,
            version_group_id: t.version_group_id,
            consensus_branch_id: 0,
            expiry_height: t.expiry_height,
            value_balance: t.value_balance,
            inputs: t.inputs.into_iter().map(Into::into).collect(),
            outputs: t.outputs,
            lock_time: t.lock_time,
            join_splits: t.join_splits.clone(),
            shielded_spends: t.shielded_spends.clone(),
            shielded_outputs: t.shielded_outputs.clone(),
            zcash: t.zcash,
            posv: t.posv,
            str_d_zeel: t.str_d_zeel,
            hash_algo: t.tx_hash_algo.into(),
        }
    }
}

/// Used during transaction construction with dynamic fee calculation (sat per kbyte)
/// to calculate tx size, TransactionInputSigner doesn't implement Serializable
impl From<TransactionInputSigner> for Transaction {
    fn from(t: TransactionInputSigner) -> Self {
        Transaction {
            version: t.version,
            n_time: t.n_time,
            overwintered: t.overwintered,
            version_group_id: t.version_group_id,
            expiry_height: t.expiry_height,
            value_balance: t.value_balance,
            inputs: t
                .inputs
                .into_iter()
                .map(|input| TransactionInput {
                    previous_output: input.previous_output,
                    script_sig: vec![].into(),
                    sequence: input.sequence,
                    script_witness: vec![],
                })
                .collect(),
            outputs: t.outputs,
            lock_time: t.lock_time,
            join_splits: t.join_splits.clone(),
            shielded_spends: t.shielded_spends.clone(),
            shielded_outputs: t.shielded_outputs.clone(),
            zcash: t.zcash,
            posv: t.posv,
            binding_sig: H512::default(),
            join_split_pubkey: H256::default(),
            join_split_sig: H512::default(),
            str_d_zeel: t.str_d_zeel,
            tx_hash_algo: t.hash_algo.into(),
        }
    }
}

impl TransactionInputSigner {
    pub fn signature_hash(
        &self,
        input_index: usize,
        input_amount: u64,
        script_pubkey: &Script,
        sigversion: SignatureVersion,
        sighashtype: u32,
    ) -> H256 {
        let sighash = Sighash::from_u32(sigversion, sighashtype);
        match sigversion {
            SignatureVersion::ForkId if sighash.fork_id => {
                self.signature_hash_fork_id(input_index, input_amount, script_pubkey, sighashtype, sighash)
            },
            SignatureVersion::Base | SignatureVersion::ForkId => {
                self.signature_hash_original(input_index, script_pubkey, sighashtype, sighash)
            },
            SignatureVersion::WitnessV0 => {
                self.signature_hash_witness0(input_index, input_amount, script_pubkey, sighashtype, sighash)
            },
        }
    }

    /// input_index - index of input to sign
    /// script_pubkey - script_pubkey of input's previous_output pubkey
    pub fn signed_input(
        &self,
        keypair: &KeyPair,
        input_index: usize,
        input_amount: u64,
        script_pubkey: &Script,
        sigversion: SignatureVersion,
        sighash: u32,
    ) -> TransactionInput {
        let hash = self.signature_hash(input_index, input_amount, script_pubkey, sigversion, sighash);

        let mut signature: Vec<u8> = keypair.private().sign(&hash).unwrap().into();
        signature.push(sighash as u8);
        let script_sig = Builder::default()
            .push_data(&signature)
            //.push_data(keypair.public())
            .into_script();

        let unsigned_input = &self.inputs[input_index];
        TransactionInput {
            previous_output: unsigned_input.previous_output,
            sequence: unsigned_input.sequence,
            script_sig: script_sig.to_bytes(),
            script_witness: vec![],
        }
    }

    pub fn signature_hash_original(
        &self,
        input_index: usize,
        script_pubkey: &Script,
        sighashtype: u32,
        sighash: Sighash,
    ) -> H256 {
        if input_index >= self.inputs.len() {
            return 1u8.into();
        }

        if self.version >= 3 && self.overwintered {
            return self
                .signature_hash_overwintered(input_index, script_pubkey, sighashtype, sighash)
                .unwrap();
        }

        if sighash.base == SighashBase::Single && input_index >= self.outputs.len() {
            return 1u8.into();
        }

        let script_pubkey = script_pubkey.without_separators();

        let inputs = if sighash.anyone_can_pay {
            let input = &self.inputs[input_index];
            vec![TransactionInput {
                previous_output: input.previous_output,
                script_sig: script_pubkey.to_bytes(),
                sequence: input.sequence,
                script_witness: vec![],
            }]
        } else {
            self.inputs
                .iter()
                .enumerate()
                .map(|(n, input)| TransactionInput {
                    previous_output: input.previous_output,
                    script_sig: if n == input_index {
                        script_pubkey.to_bytes()
                    } else {
                        Bytes::default()
                    },
                    sequence: match sighash.base {
                        SighashBase::Single | SighashBase::None if n != input_index => 0,
                        _ => input.sequence,
                    },
                    script_witness: vec![],
                })
                .collect()
        };

        let outputs = match sighash.base {
            SighashBase::All => self.outputs.clone(),
            SighashBase::Single => self
                .outputs
                .iter()
                .take(input_index + 1)
                .enumerate()
                .map(|(n, out)| {
                    if n == input_index {
                        out.clone()
                    } else {
                        TransactionOutput::default()
                    }
                })
                .collect(),
            SighashBase::None => Vec::new(),
        };

        // PoSV transactions have n_time truncated when creating signed inputs
        let n_time: Option<u32> = if self.posv { None } else { self.n_time };

        let tx = Transaction {
            inputs,
            outputs,
            version: self.version,
            n_time,
            lock_time: self.lock_time,
            binding_sig: H512::default(),
            expiry_height: 0,
            join_split_pubkey: H256::default(),
            join_split_sig: H512::default(),
            join_splits: vec![],
            overwintered: false,
            shielded_spends: vec![],
            shielded_outputs: vec![],
            value_balance: 0,
            version_group_id: 0,
            zcash: self.zcash,
            posv: self.posv,
            str_d_zeel: self.str_d_zeel.clone(),
            tx_hash_algo: self.hash_algo.into(),
        };

        let mut stream = Stream::default();
        stream.append(&tx);
        stream.append(&sighashtype);
        let out = stream.out();
        match self.hash_algo {
            SignerHashAlgo::DSHA256 => dhash256(&out),
            SignerHashAlgo::SHA256 => sha256(&out),
        }
    }

    fn signature_hash_witness0(
        &self,
        input_index: usize,
        input_amount: u64,
        script_pubkey: &Script,
        sighashtype: u32,
        sighash: Sighash,
    ) -> H256 {
        let hash_prevouts = compute_hash_prevouts(sighash, &self.inputs);
        let hash_sequence = compute_hash_sequence(sighash, &self.inputs);
        let hash_outputs = compute_hash_outputs(sighash, input_index, &self.outputs);

        let mut stream = Stream::default();
        stream.append(&self.version);
        stream.append(&hash_prevouts);
        stream.append(&hash_sequence);
        stream.append(&self.inputs[input_index].previous_output);
        stream.append_list(script_pubkey);
        stream.append(&input_amount);
        stream.append(&self.inputs[input_index].sequence);
        stream.append(&hash_outputs);
        stream.append(&self.lock_time);
        stream.append(&sighashtype); // this also includes 24-bit fork id. which is 0 for BitcoinCash
        let out = stream.out();
        dhash256(&out)
    }

    fn signature_hash_fork_id(
        &self,
        input_index: usize,
        input_amount: u64,
        script_pubkey: &Script,
        sighashtype: u32,
        sighash: Sighash,
    ) -> H256 {
        if input_index >= self.inputs.len() {
            return 1u8.into();
        }

        if sighash.base == SighashBase::Single && input_index >= self.outputs.len() {
            return 1u8.into();
        }

        self.signature_hash_witness0(input_index, input_amount, script_pubkey, sighashtype, sighash)
    }

    /// https://github.com/zcash/zips/blob/master/zip-0243.rst#notes
    /// This method doesn't cover all possible Sighash combinations so it doesn't fully match the
    /// specification, however I don't need other cases yet as BarterDEX marketmaker always uses
    /// SIGHASH_ALL
    pub fn signature_hash_overwintered(
        &self,
        input_index: usize,
        script_pubkey: &Script,
        sighashtype: u32,
        sighash: Sighash,
    ) -> Result<H256, String> {
        let mut sig_hash_stream = Stream::new();

        let mut personalization = ZCASH_SIG_HASH_PERSONALIZATION.to_vec();
        // uint32_t leConsensusBranchId = htole32(consensusBranchId);
        // unsigned char personalization[16] = {};
        // memcpy(personalization, "ZcashSigHash", 12);
        // memcpy(personalization+12, &leConsensusBranchId, 4);
        // https://github.com/zcash/zcash/issues/3413
        if self.version >= 3 {
            personalization.extend_from_slice(&self.consensus_branch_id.to_le_bytes());
        }

        let mut header = self.version;
        if self.overwintered {
            header |= 1 << 31;
        }
        sig_hash_stream.append(&header);
        sig_hash_stream.append(&self.version_group_id);

        if !sighash.anyone_can_pay {
            let mut prev_out_stream = Stream::new();
            for input in self.inputs.iter() {
                prev_out_stream.append(&input.previous_output);
            }
            sig_hash_stream.append(&blake_2b_256_personal(
                &prev_out_stream.out(),
                ZCASH_PREVOUTS_HASH_PERSONALIZATION,
            ));
        } else {
            sig_hash_stream.append(&H256::default());
        }

        if !sighash.anyone_can_pay && sighash.base != SighashBase::Single && sighash.base != SighashBase::None {
            let mut sequence_stream = Stream::new();
            for input in self.inputs.iter() {
                sequence_stream.append(&input.sequence);
            }

            sig_hash_stream.append(&blake_2b_256_personal(
                &sequence_stream.out(),
                ZCASH_SEQUENCE_HASH_PERSONALIZATION,
            ));
        } else {
            sig_hash_stream.append(&H256::default());
        }

        if sighash.base != SighashBase::Single && sighash.base != SighashBase::None {
            let mut outputs_stream = Stream::new();
            for output in self.outputs.iter() {
                outputs_stream.append(output);
            }

            sig_hash_stream.append(&blake_2b_256_personal(
                &outputs_stream.out(),
                ZCASH_OUTPUTS_HASH_PERSONALIZATION,
            ));
        } else if sighash.base == SighashBase::Single && input_index < self.outputs.len() {
            let mut outputs_stream = Stream::new();
            outputs_stream.append(&self.outputs[input_index]);

            sig_hash_stream.append(&blake_2b_256_personal(
                &outputs_stream.out(),
                ZCASH_OUTPUTS_HASH_PERSONALIZATION,
            ));
        } else {
            sig_hash_stream.append(&H256::default());
        }

        if !self.join_splits.is_empty() {
            let mut join_splits_stream = Stream::new();
            for split in self.join_splits.iter() {
                join_splits_stream.append(split);
            }
            sig_hash_stream.append(&blake_2b_256_personal(
                &join_splits_stream.out(),
                ZCASH_JOIN_SPLITS_HASH_PERSONALIZATION,
            ));
        } else {
            sig_hash_stream.append(&H256::default());
        }

        if !self.shielded_spends.is_empty() {
            let mut s_spends_stream = Stream::new();
            for spend in self.shielded_spends.iter() {
                s_spends_stream
                    .append(&spend.cv)
                    .append(&spend.anchor)
                    .append(&spend.nullifier)
                    .append(&spend.rk)
                    .append(&spend.zkproof);
            }
            sig_hash_stream.append(&blake_2b_256_personal(
                &s_spends_stream.out(),
                ZCASH_SHIELDED_SPENDS_HASH_PERSONALIZATION,
            ));
        } else {
            sig_hash_stream.append(&H256::default());
        }

        if !self.shielded_outputs.is_empty() {
            let mut s_outputs_stream = Stream::new();
            for output in self.shielded_outputs.iter() {
                s_outputs_stream.append(output);
            }
            let hash_shielded_outputs =
                blake_2b_256_personal(&s_outputs_stream.out(), ZCASH_SHIELDED_OUTPUTS_HASH_PERSONALIZATION);
            sig_hash_stream.append(&hash_shielded_outputs);
        } else {
            sig_hash_stream.append(&H256::default());
        }

        sig_hash_stream.append(&self.lock_time);
        sig_hash_stream.append(&self.expiry_height);
        sig_hash_stream.append(&self.value_balance);
        sig_hash_stream.append(&sighashtype);

        sig_hash_stream.append(&self.inputs[input_index].previous_output);
        sig_hash_stream.append(&script_pubkey.to_bytes());
        sig_hash_stream.append(&self.inputs[input_index].amount);
        sig_hash_stream.append(&self.inputs[input_index].sequence);

        Ok(blake_2b_256_personal(&sig_hash_stream.out(), &personalization))
    }
}

fn compute_hash_prevouts(sighash: Sighash, inputs: &[UnsignedTransactionInput]) -> H256 {
    match sighash.anyone_can_pay {
        false => {
            let mut stream = Stream::default();
            for input in inputs {
                stream.append(&input.previous_output);
            }
            dhash256(&stream.out())
        },
        true => 0u8.into(),
    }
}

fn compute_hash_sequence(sighash: Sighash, inputs: &[UnsignedTransactionInput]) -> H256 {
    match sighash.base {
        SighashBase::All if !sighash.anyone_can_pay => {
            let mut stream = Stream::default();
            for input in inputs {
                stream.append(&input.sequence);
            }
            dhash256(&stream.out())
        },
        _ => 0u8.into(),
    }
}

fn compute_hash_outputs(sighash: Sighash, input_index: usize, outputs: &[TransactionOutput]) -> H256 {
    match sighash.base {
        SighashBase::All => {
            let mut stream = Stream::default();
            for output in outputs {
                stream.append(output);
            }
            dhash256(&stream.out())
        },
        SighashBase::Single if input_index < outputs.len() => {
            let mut stream = Stream::default();
            stream.append(&outputs[input_index]);
            dhash256(&stream.out())
        },
        _ => 0u8.into(),
    }
}

fn blake_2b_256_personal(input: &[u8], personal: &[u8]) -> H256 {
    H256::from(
        Blake2b::new()
            .hash_length(32)
            .personal(personal)
            .to_state()
            .update(input)
            .finalize()
            .as_bytes(),
    )
}

#[cfg(test)]
mod tests {
    use super::{blake_2b_256_personal, Sighash, SighashBase, SignatureVersion, TransactionInputSigner,
                UnsignedTransactionInput};
    use bytes::Bytes;
    use chain::{OutPoint, Transaction, TransactionOutput};
    use hash::{H160, H256};
    use keys::{prefixes::{BTC_PREFIXES, T_BTC_PREFIXES},
               Address, AddressHashEnum, Private};
    use script::Script;
    use ser::deserialize;
    use sign::SignerHashAlgo;

    // http://www.righto.com/2014/02/bitcoins-hard-way-using-raw-bitcoin.html
    // https://blockchain.info/rawtx/81b4c832d70cb56ff957589752eb4125a4cab78a25a8fc52d6a09e5bd4404d48
    // https://blockchain.info/rawtx/3f285f083de7c0acabd9f106a43ec42687ab0bebe2e6f0d529db696794540fea
    #[test]
    fn test_signature_hash_simple() {
        let _private: Private = "5HusYj2b2x4nroApgfvaSfKYZhRbKFH41bVyPooymbC6KfgSXdD".into();
        let previous_tx_hash =
            H256::from_reversed_str("81b4c832d70cb56ff957589752eb4125a4cab78a25a8fc52d6a09e5bd4404d48");
        let previous_output_index = 0;
        let to: Address = Address::from_legacyaddress("1KKKK6N21XKo48zWKuQKXdvSsCf95ibHFa", &BTC_PREFIXES).unwrap();
        assert!(to.hash().is_address_hash());
        let previous_output = "76a914df3bd30160e6c6145baaf2c88a8844c13a00d1d588ac".into();
        let current_output: Bytes = "76a914c8e90996c7c6080ee06284600c684ed904d14c5c88ac".into();
        let value = 91234;
        let expected_signature_hash: H256 = "5fda68729a6312e17e641e9a49fac2a4a6a680126610af573caab270d232f850".into();

        // this is irrelevant
        let mut hash = H160::default();
        if let AddressHashEnum::AddressHash(h) = to.hash() {
            hash = *h;
        }
        assert_eq!(&current_output[3..23], &*hash);

        let unsigned_input = UnsignedTransactionInput {
            sequence: 0xffff_ffff,
            previous_output: OutPoint {
                index: previous_output_index,
                hash: previous_tx_hash,
            },
            amount: 0,
            witness: vec![Vec::new()],
        };

        let output = TransactionOutput {
            value,
            script_pubkey: current_output,
        };

        let input_signer = TransactionInputSigner {
            version: 1,
            n_time: None,
            overwintered: false,
            version_group_id: 0,
            consensus_branch_id: 0,
            expiry_height: 0,
            value_balance: 0,
            lock_time: 0,
            inputs: vec![unsigned_input],
            outputs: vec![output],
            join_splits: vec![],
            shielded_spends: vec![],
            shielded_outputs: vec![],
            zcash: false,
            posv: false,
            str_d_zeel: None,
            hash_algo: SignerHashAlgo::DSHA256,
        };

        let hash = input_signer.signature_hash(0, 0, &previous_output, SignatureVersion::Base, SighashBase::All.into());
        assert_eq!(hash, expected_signature_hash);
    }

    #[test]
    fn test_signature_hash_posv() {
        let _private: Private = "cSQJp8ymcCUZCceowcTr5L1rr7tRbeB8uj3pDFRfRaMuRP6yDqfa".into();
        let previous_tx_hash =
            H256::from_reversed_str("0bc54ed426950f50bf2c2776034a03592e844757b42330eb908eb04492dad2c6");
        let previous_output_index = 1;
        let to: Address = Address::from_legacyaddress("msj7SEQmH7pUCUx8YU6R87DrAHYzcABdzw", &T_BTC_PREFIXES).unwrap();
        assert!(to.hash().is_address_hash());
        let previous_output = "76a914df3bd30160e6c6145baaf2c88a8844c13a00d1d588ac".into();
        let current_output: Bytes = "76a91485ee21a7f8cdd9034fb55004e0d8ed27db1c03c288ac".into();
        let value = 100000000;
        let expected_signature_hash: H256 = "21d91397ba4e4bfaf73584300804cf9f9fd11cabe43f1bb38f7986cea5ef5519".into();

        let unsigned_input = UnsignedTransactionInput {
            sequence: 0xffff_ffff,
            previous_output: OutPoint {
                index: previous_output_index,
                hash: previous_tx_hash,
            },
            amount: 100,
            witness: vec![Vec::new()],
        };

        let output = TransactionOutput {
            value,
            script_pubkey: current_output,
        };

        let input_signer = TransactionInputSigner {
            version: 2,
            n_time: Some(1682050928),
            overwintered: false,
            version_group_id: 0,
            consensus_branch_id: 0,
            expiry_height: 0,
            value_balance: 0,
            lock_time: 0,
            inputs: vec![unsigned_input],
            outputs: vec![output],
            join_splits: vec![],
            shielded_spends: vec![],
            shielded_outputs: vec![],
            zcash: false,
            posv: true,
            str_d_zeel: None,
            hash_algo: SignerHashAlgo::DSHA256,
        };

        let hash = input_signer.signature_hash(0, 0, &previous_output, SignatureVersion::Base, SighashBase::All.into());
        assert_eq!(hash, expected_signature_hash);
    }

    #[allow(dead_code)]
    fn run_test_sighash(
        tx: &'static str,
        script: &'static str,
        input_index: usize,
        hash_type: i32,
        result: &'static str,
    ) {
        let tx: Transaction = tx.into();
        let signer: TransactionInputSigner = tx.into();
        let script: Script = script.into();
        let expected = H256::from_reversed_str(result);

        let sighash = Sighash::from_u32(SignatureVersion::Base, hash_type as u32);
        let hash = signer.signature_hash_original(input_index, &script, hash_type as u32, sighash);
        assert_eq!(expected, hash);
    }

    #[test]
    fn test_sighash_forkid_from_u32() {
        assert!(!Sighash::is_defined(SignatureVersion::Base, 0xFFFFFF82));
        assert!(!Sighash::is_defined(SignatureVersion::Base, 0x00000182));
        assert!(!Sighash::is_defined(SignatureVersion::Base, 0x00000080));
        assert!(Sighash::is_defined(SignatureVersion::Base, 0x00000001));
        assert!(Sighash::is_defined(SignatureVersion::Base, 0x00000082));
        assert!(Sighash::is_defined(SignatureVersion::Base, 0x00000003));

        assert!(!Sighash::is_defined(SignatureVersion::ForkId, 0xFFFFFFC2));
        assert!(!Sighash::is_defined(SignatureVersion::ForkId, 0x000001C2));
        assert!(Sighash::is_defined(SignatureVersion::ForkId, 0x00000081));
        assert!(Sighash::is_defined(SignatureVersion::ForkId, 0x000000C2));
        assert!(Sighash::is_defined(SignatureVersion::ForkId, 0x00000043));
    }

    #[test]
    fn test_blake_2b_personal() {
        let hash = blake_2b_256_personal(b"", b"ZcashPrevoutHash");
        assert_eq!(
            H256::from("d53a633bbecf82fe9e9484d8a0e727c73bb9e68c96e72dec30144f6a84afa136"),
            hash
        );
    }

    // https://github.com/zcash/zips/blob/master/zip-0243.rst#test-vector-3
    // The preimage and hash in Zcash example are invalid.
    // scriptCode length should be appended to Input part first but it's not there in example.
    #[test]
    fn test_sapling_sig_hash() {
        let tx: Transaction = "0400008085202f8901a8c685478265f4c14dada651969c45a65e1aeb8cd6791f2f5bb6a1d9952104d9010000006b483045022100a61e5d557568c2ddc1d9b03a7173c6ce7c996c4daecab007ac8f34bee01e6b9702204d38fdc0bcf2728a69fde78462a10fb45a9baa27873e6a5fc45fb5c76764202a01210365ffea3efa3908918a8b8627724af852fc9b86d7375b103ab0543cf418bcaa7ffeffffff02005a6202000000001976a9148132712c3ff19f3a151234616777420a6d7ef22688ac8b959800000000001976a9145453e4698f02a38abdaa521cd1ff2dee6fac187188ac29b0040048b004000000000000000000000000".into();
        let mut signer = TransactionInputSigner::from(tx);
        signer.inputs[0].amount = 50000000;
        signer.consensus_branch_id = 0x76b809bb;

        let sig_hash = Sighash::from_u32(SignatureVersion::Base, 1);
        let hash = signer.signature_hash_overwintered(
            0,
            &Script::from("1976a914507173527b4c3318a2aecd793bf1cfed705950cf88ac"),
            1,
            sig_hash,
        );

        assert_eq!(
            H256::from("f27411aa9bd02879181c763a80bdb6f9ea9158f0de71757e7e12ed17760ebe3f"),
            hash.unwrap()
        );

        let hash = signer.signature_hash(
            0,
            0,
            &Script::from("1976a914507173527b4c3318a2aecd793bf1cfed705950cf88ac"),
            SignatureVersion::Base,
            1,
        );

        assert_eq!(
            H256::from("f27411aa9bd02879181c763a80bdb6f9ea9158f0de71757e7e12ed17760ebe3f"),
            hash
        );
    }

    #[test]
    fn test_sapling_sig_hash_2() {
        let tx: Transaction = "0400008085202f89012c07a03638d9cf4d2cc837784b3b06aa9a5c8b819f7cb0d373bf711108f4c0f2010000006b483045022100fceec7ffa2686377fa2e13d43aa1d8836c3b5ace5292dd2f65a75befec2660bd02205dc000c13a89975bf3fe85aa9c891fcdea6eb25bd5459ad204fe2946d22e49c3012102031d4256c4bc9f99ac88bf3dba21773132281f65f9bf23a59928bce08961e2f3ffffffff0240420f00000000001976a91405aab5342166f8594baf17a7d9bef5d56744332788ac7c288800000000001976a91405aab5342166f8594baf17a7d9bef5d56744332788ac00000000000000000000000000000000000000".into();
        let mut signer = TransactionInputSigner::from(tx);
        signer.inputs[0].amount = 9924260;
        signer.consensus_branch_id = 0x76b809bb;

        let sig_hash = Sighash::from_u32(SignatureVersion::Base, 1);
        let hash = signer.signature_hash_overwintered(
            0,
            &Script::from("76a91405aab5342166f8594baf17a7d9bef5d56744332788ac"),
            1,
            sig_hash,
        );

        assert_eq!(
            H256::from("047da0d9932545770fc570122c4451b53fadad219650008e5026162e957a46f9"),
            hash.unwrap()
        );

        let hash = signer.signature_hash(
            0,
            0,
            &Script::from("76a91405aab5342166f8594baf17a7d9bef5d56744332788ac"),
            SignatureVersion::Base,
            1,
        );

        assert_eq!(
            H256::from("047da0d9932545770fc570122c4451b53fadad219650008e5026162e957a46f9"),
            hash
        );
    }

    #[test]
    fn test_sapling_sig_hash_3() {
        let tx: Transaction = "0400008085202f890162878ceccb1d4ea904681f3fffad22ec79aeea7e83f117a579ec60859ab9ee3e0000000000feffffff00e5c29360c701000010460afaffffffff00015280edc62c0e174cc112dfcc5c47c34d74d119bca3850c54bbe6383ed4d0d9f242c8cb5819674460802bd39257bf0bb7c7b5e9f9efb051e6f48d681f088c916e713187a7fcbce4eb6ec7f35d5bbdab1225ded98e2f845cddae36ebf45c9e7e00e28614c05416da18888e3883e9667e2df9a513612fe41df4c462b28473c1f10aa03cec99d1e4e23cd84d1bfee827ec9077ddb0d0537660017778e880c7835c9d81e4d8cfb1def0506805cac8fd3ebf2f231d15fbd9807e0ec7c50d26b24f8f07b21552dc0abc0feb4e7ee7ee40c620a07160a87a4683801539e4b22f0778960dd0a6e2b8d6b09cd5e0fbf40484340f9a88c0bea726d6221244ea5ba859f04af0dc8798c4e4379620bad0b7ac9093d877f23431f30a39173f8a2db2a6665a0cc0180f9eab676cac85aeeee14ec53abbb94f977b01437310c4543a390e4e4838c6a3b9de82d63ed7c4032d9c32d631adb477391a30807fffd33f98b8ed72b0684eb9f6afd02a4d9c935353448103d490f7095a725f75d75c3539d4e9ea7b76a725d4898403e9047288ad2ba46bec0e130f5ed160e4b2cf7a0db768a7a1f158baf067f6996f171269fa41df02c5b588fd12d430b40f8763b1d2f4b234f6a490ae90266c262fa8ec8da3172e87064d97d3a2a2700b5215739196553fe2d69db970f8b8d0252439f7829dcc7d8ec17dfa85e53320e26650876888a7505327b03abecb91b6367e4c3feada297ae0eff32ce0ff3780d924cb2f19ae97bb648fa6a49e6a8677ef4aa08b55bc9ae77ac6a2a7ad26c3c7ac718ef263ea53fbad012c641aed9997221a283743e337e97aa62ef6db3ae13835f4b572000f8c5a32b73aecfc7ae68b2b9924b6dde7c6fcca207e25feae0a024c4fcfd0207e9ad346b36af5fd581769cac99daeab680c593a617d9571ed5c247846d14cecda2acfe9cfbbb22408c1bc3bb7da3f7ac4a8ca0726ba01ee4531b5036fcc376970998b617d6cef7bbe4bdbf77d6adaebbdc0542ea60ff25b30cde6764777d1f821fd60f91499ccb3aac20d5ccd01ed313a53ac33bcbdaca460209aaa0e94feb16a82cbaa902210644777a21862c7dbc30df403c75e04dc47696230cf40dfa1045f480abdbebf4ebcbac6f700f287cef3d4b147ddf0e8e9d02ee9baa51604682d5b983dc6f8abee274be0e02a8a7de3fbb22563726c2e7d34b15c437e560e7ce1569ea2ed16e37d908e60af15fd44e46b8969fa74a0f24147553947da7db10fa3394c54413f1b4d6dfcab790a3a91027a1947a229644da8663f05bd05ff4a8621db679467ab74bf8eab1be5861f80b004af53cb679be479e82aa3de8ae5002521474e197975860a9b506e698ffaa385803c656dd984b60b0569ad617c6347722fddbde10f0f485362fbedfde0a600bf551c3f8b02778c4d6960a533fcb302".into();
        let mut signer = TransactionInputSigner::from(tx);
        signer.inputs[0].amount = 100000000;
        signer.consensus_branch_id = 0x76b809bb;

        let sig_hash = Sighash::from_u32(SignatureVersion::Base, 1);
        let hash = signer.signature_hash_overwintered(
			0,
			&Script::from("6304e5928060b17521031c632dad67a611de77d9666cbc61e65957c7d7544c25e384f4e76de729e6a1bfac6782012088a914b78f0b837e2c710f8b28e59d06473d489e5315c88821037310a8fb9fd8f198a1a21db830252ad681fccda580ed4101f3f6bfb98b34fab5ac68"),
			1,
			sig_hash
		);

        assert_eq!(
            H256::from("4e8465af6add3acdc3bbc05d97ab1aef8e9d66784c29f94b2551ba25f3d90054"),
            hash.unwrap().reversed()
        );

        let hash = signer.signature_hash(
			0,
            0,
			&Script::from("6304e5928060b17521031c632dad67a611de77d9666cbc61e65957c7d7544c25e384f4e76de729e6a1bfac6782012088a914b78f0b837e2c710f8b28e59d06473d489e5315c88821037310a8fb9fd8f198a1a21db830252ad681fccda580ed4101f3f6bfb98b34fab5ac68"),
			SignatureVersion::Base,
            1
		);

        assert_eq!(
            H256::from("4e8465af6add3acdc3bbc05d97ab1aef8e9d66784c29f94b2551ba25f3d90054"),
            hash.reversed()
        );
    }

    #[test]
    fn test_sapling_sig_hash_single() {
        let tx = vec![
            0x04, 0x00, 0x00, 0x80, 0x85, 0x20, 0x2f, 0x89, 0x02, 0x88, 0x1d, 0xdf, 0x4f, 0x95, 0x78, 0x97, 0x34, 0xfc,
            0xc1, 0x65, 0xee, 0x1e, 0x04, 0x40, 0x85, 0xb6, 0xe7, 0xa1, 0x77, 0x50, 0x8c, 0x29, 0xda, 0x0c, 0xe7, 0x7d,
            0xed, 0x75, 0x08, 0x98, 0xde, 0x89, 0xd2, 0x60, 0xd3, 0x02, 0x63, 0x52, 0x44, 0xcc, 0x75, 0xe1, 0x98, 0x34,
            0x52, 0x5f, 0xba, 0x56, 0x90, 0x0d, 0xe9, 0x93, 0x85, 0x44, 0x2e, 0xb9, 0xec, 0x9a, 0x5f, 0x18, 0x2b, 0x87,
            0x5d, 0x70, 0xb5, 0xb1, 0x53, 0x79, 0x0a, 0x1e, 0xe7, 0x9c, 0x0e, 0x86, 0x78, 0x37, 0x95, 0xfa, 0x06, 0x6a,
            0x00, 0x63, 0x00, 0x00, 0x63, 0xfc, 0x92, 0x29, 0x92, 0x00, 0x83, 0x64, 0xff, 0xfc, 0x7c, 0x00, 0xc0, 0x0e,
            0x0f, 0x99, 0xde, 0x47, 0x42, 0x89, 0x06, 0x00, 0x01, 0x39, 0x21, 0x97, 0xd6, 0x23, 0xf7, 0xeb, 0xda, 0x07,
            0xcd, 0x00, 0x58, 0xd9, 0xa1, 0xd1, 0x72, 0x04, 0x3c, 0x2f, 0xc9, 0x4f, 0x14, 0x19, 0x3e, 0x27, 0x0e, 0xef,
            0xe8, 0x3c, 0x3f, 0x01, 0xb2, 0x65, 0x05, 0x4c, 0x3f, 0x6a, 0x60, 0xe2, 0xb7, 0x6e, 0x17, 0x56, 0x08, 0x8b,
            0x87, 0xda, 0x83, 0x9f, 0x77, 0x2c, 0xbd, 0x0f, 0x27, 0x5c, 0x92, 0x28, 0x38, 0x5a, 0x04, 0xbb, 0x50, 0xec,
            0x3c, 0xfa, 0x9e, 0xe2, 0xe1, 0x5b, 0x15, 0x3d, 0x4c, 0x85, 0xfe, 0x50, 0xb6, 0x00, 0x62, 0x58, 0xe9, 0xe8,
            0xc2, 0x52, 0x99, 0xc0, 0x9d, 0xf8, 0xb4, 0x55, 0x46, 0x6b, 0xa2, 0x5f, 0x7e, 0x4c, 0x8f, 0xe7, 0xe2, 0x50,
            0xed, 0xba, 0x60, 0x69, 0x5d, 0xa4, 0x7f, 0xaa, 0xfd, 0xd6, 0x26, 0xba, 0x7e, 0x9d, 0x48, 0x96, 0xe4, 0xb8,
            0xa8, 0xa1, 0xa1, 0xdc, 0x21, 0x5b, 0x0a, 0x25, 0xee, 0xb0, 0x4e, 0xd1, 0xbe, 0xfb, 0x5b, 0x31, 0x38, 0xc6,
            0x9f, 0xe5, 0x28, 0xe7, 0x29, 0x11, 0x23, 0xfc, 0xdf, 0x8a, 0x36, 0x6c, 0x25, 0x7d, 0x32, 0x95, 0x38, 0x25,
            0x0a, 0x0c, 0xb7, 0xf5, 0x4e, 0x1c, 0x01, 0x6c, 0xe1, 0xc6, 0x23, 0xb2, 0xe2, 0x76, 0xa5, 0x2c, 0x6e, 0x41,
            0x24, 0x1b, 0x2a, 0xc5, 0x09, 0x37, 0x3c, 0x18, 0x81, 0x40, 0xe8, 0x36, 0x5c, 0x94, 0xf5, 0x8c, 0x63, 0xf2,
            0x7f, 0xf8, 0xe6, 0xe8, 0x69, 0xa9, 0x85, 0xaf, 0xb6, 0x1e, 0x97, 0xd8, 0xce, 0xec, 0x2a, 0x78, 0x24, 0xa5,
            0xc1, 0x07, 0xb0, 0xba, 0xa4, 0xd6, 0xe7, 0x9a, 0x6c, 0x71, 0x87, 0x2a, 0x7b, 0x3b, 0x17, 0xef, 0x91, 0x8a,
            0xe4, 0xe2, 0x5f, 0x98, 0xa7, 0x2d, 0xb5, 0x3b, 0xa7, 0xf2, 0x6e, 0x40, 0x8b, 0xd4, 0xd1, 0xf9, 0xe3, 0x47,
            0x4d, 0xdc, 0xa5, 0x83, 0x3f, 0xf5, 0xff, 0x8d, 0x11, 0xb1, 0xbf, 0x1e, 0x2b, 0xb4, 0xd1, 0x96, 0x8a, 0x82,
            0x38, 0x88, 0xbd, 0x91, 0xa2, 0x1a, 0x76, 0x79, 0x6b, 0xca, 0x44, 0x53, 0xe2, 0x89, 0x2d, 0x1b, 0x6e, 0x13,
            0x63, 0xed, 0x10, 0x7a, 0x9e, 0x7e, 0xd9, 0x3f, 0xb1, 0xda, 0x99, 0x4a, 0x9d, 0x4e, 0x7e, 0xc9, 0x2e, 0x29,
            0xa6, 0x87, 0xf2, 0x18, 0xd2, 0x8a, 0x76, 0x46, 0x06, 0x9b, 0xca, 0xcb, 0x4d, 0xa7, 0xba, 0xdf, 0x4e, 0xb1,
            0x33, 0x1a, 0xab, 0x21, 0x2b, 0x92, 0xc6, 0xea, 0x64, 0x76, 0xa0, 0xa0, 0x9d, 0x6b, 0xd2, 0xe0, 0xf7, 0x6f,
            0xa8, 0x73, 0x79, 0xab, 0xfd, 0x17, 0x58, 0x2f, 0x3e, 0xb2, 0x3b, 0x86, 0xc9, 0x66, 0x9f, 0x86, 0x73, 0x70,
            0x48, 0xd7, 0x71, 0x84, 0x9b, 0x8f, 0x70, 0xbd, 0x87, 0x99, 0x01, 0x3b, 0xe0, 0xbf, 0xbd, 0x7b, 0x57, 0xbe,
            0xa1, 0xa4, 0x9a, 0x4a, 0x39, 0x14, 0x79, 0x12, 0xd7, 0xba, 0xf6, 0x80, 0x04, 0xd4, 0x15, 0x02, 0x6b, 0xbc,
            0x6f, 0x69, 0x32, 0x5f, 0x4f, 0xf7, 0x87, 0x28, 0x77, 0x5a, 0x67, 0xaa, 0xdd, 0x72, 0x2c, 0x73, 0x31, 0x1d,
            0xba, 0x5c, 0x2c, 0xf1, 0x4c, 0xcb, 0xd5, 0x7e, 0xab, 0xed, 0x71, 0x92, 0x0f, 0xf9, 0x62, 0x32, 0x89, 0xbb,
            0x76, 0x05, 0x1c, 0x73, 0xa2, 0x06, 0xa3, 0xc2, 0xb4, 0x0c, 0xac, 0x01, 0xd5, 0xf1, 0x1f, 0xa6, 0x4c, 0x1b,
            0x7d, 0xed, 0x70, 0xea, 0x17, 0x42, 0x9c, 0x66, 0x21, 0xca, 0x9b, 0x92, 0x3c, 0x48, 0x11, 0x85, 0x0c, 0x3d,
            0xf4, 0x01, 0x3d, 0x17, 0xbd, 0xc5, 0x10, 0x1c, 0x8d, 0x80, 0xb3, 0xa0, 0x4a, 0x4c, 0xc2, 0x3d, 0x13, 0xfe,
            0x31, 0x84, 0xe8, 0xb1, 0xad, 0xe6, 0x35, 0x17, 0x59, 0x3f, 0x7b, 0xe6, 0x69, 0x48, 0xc0, 0x85, 0x7a, 0xec,
            0xe0, 0x1b, 0xc2, 0x72, 0x29, 0x5e, 0x60, 0xb1, 0x80, 0x69, 0x46, 0xc9, 0x3b, 0xc8, 0xc7, 0xd2, 0xa2, 0xed,
            0xc3, 0x7f, 0xa3, 0x7c, 0x47, 0x7a, 0x69, 0xa9, 0x0b, 0x59, 0xb4, 0xc6, 0x91, 0x2e, 0x91, 0x3a, 0x57, 0xef,
            0xa9, 0xd5, 0x4c, 0x7e, 0x80, 0xd5, 0xac, 0x8a, 0x42, 0x94, 0xd0, 0xfd, 0x31, 0xa4, 0x02, 0xe4, 0xb4, 0x7e,
            0xc7, 0xbf, 0x03, 0x31, 0xb2, 0xc9, 0xa4, 0x8f, 0x44, 0x57, 0x3f, 0xc7, 0xe7, 0xf1, 0x02, 0xed, 0x48, 0xc9,
            0x75, 0x08, 0xcb, 0xe4, 0x30, 0x65, 0xa9, 0xe9, 0x9f, 0xb4, 0xce, 0x13, 0x62, 0xbb, 0x8a, 0x76, 0xb1, 0x41,
            0x9d, 0x95, 0x03, 0x0e, 0x9c, 0x24, 0xee, 0xba, 0x9f, 0xf8, 0xcf, 0xda, 0x95, 0x7b, 0x17, 0x09, 0x8c, 0xdf,
            0x8c, 0x9a, 0x91, 0x9e, 0x47, 0xa1, 0x3a, 0x5b, 0x33, 0x46, 0xe3, 0x7e, 0x82, 0x7c, 0xc8, 0x3b, 0x3c, 0x9a,
            0xab, 0xf2, 0xd0, 0xba, 0x17, 0xff, 0x3d, 0x9e, 0x0d, 0x22, 0x3c, 0x41, 0xc8, 0x8e, 0xc2, 0x39, 0x1c, 0x76,
            0x62, 0x2d, 0x7b, 0xd6, 0x21, 0x17, 0x33, 0x1e, 0x21, 0xff, 0xec, 0x32, 0x72, 0xc1, 0xe1, 0x42, 0x39, 0x82,
            0xc6, 0xb6, 0x3a, 0xec, 0x8d, 0xbf, 0x5c, 0xa2, 0xdd, 0x15, 0x81, 0x0f, 0x53, 0x42, 0xaf, 0x49, 0xfa, 0xd2,
            0x79, 0xb7, 0xca, 0x23, 0xde, 0xd3, 0x08, 0x24, 0x79, 0x96, 0x30, 0xde, 0xdc, 0x6d, 0xb7, 0x24, 0xbc, 0xe1,
            0x11, 0x36, 0x21, 0xc4, 0xa6, 0x47, 0x9d, 0xd5, 0x55, 0xf4, 0x85, 0x21, 0x7c, 0xb5, 0x67, 0x13, 0x9e, 0xea,
            0xdd, 0x7e, 0xe8, 0xdc, 0x5b, 0x26, 0x62, 0xf1, 0x06, 0x6a, 0x7c, 0x60, 0xde, 0xe0, 0x09, 0x3c, 0x92, 0x46,
            0xde, 0x7a, 0x05, 0xe8, 0xb0, 0xf6, 0xbe, 0xf0, 0x03, 0x3d, 0xde, 0x2e, 0x87, 0xcb, 0xa6, 0x8d, 0x23, 0x6e,
            0xf6, 0x6a, 0x23, 0xd5, 0x5e, 0x7b, 0xd2, 0x8d, 0x02, 0x59, 0x9c, 0xca, 0x0d, 0xf7, 0xa9, 0x00, 0x63, 0x7b,
            0xb3, 0x46, 0x4d, 0x62, 0x2b, 0x7c, 0x9c, 0x9c, 0x8c, 0x91, 0x46, 0x89, 0x74, 0x88, 0x01, 0x64, 0xde, 0xf7,
            0x99, 0x90, 0x8a, 0x11, 0xa5, 0x91, 0xab, 0xb3, 0xc8, 0xd8, 0xbd, 0x9c, 0x12, 0xb1, 0xf6, 0xf3, 0xcd, 0xc9,
            0xed, 0x8e, 0x16, 0xe5, 0x7d, 0x23, 0x34, 0xb2, 0x17, 0x79, 0x7d, 0xf1, 0x90, 0x52, 0xfe, 0xeb, 0xed, 0x6c,
            0xdb, 0x99, 0xac, 0x44, 0xea, 0x13, 0xaf, 0xea, 0xc4, 0x37, 0x7d, 0x0f, 0xa3, 0x7e, 0xf5, 0x16, 0xdd, 0xac,
            0xea, 0xb0, 0xd9, 0x39, 0x5b, 0xd4, 0x40, 0x46, 0x0e, 0x28, 0xb5, 0xf5, 0x7a, 0x6e, 0xfd, 0x37, 0xd2, 0x68,
            0xa8, 0x64, 0xcb, 0x5c, 0xa3, 0x4b, 0xe2, 0x87, 0xe1, 0x04, 0x8e, 0xfc, 0x1e, 0x40, 0xcd, 0xf4, 0xfc, 0xfc,
            0x02, 0x4c, 0xf1, 0x82, 0x03, 0x8b, 0x9d, 0x80, 0xed, 0x1c, 0x07, 0x63, 0x62, 0x00, 0xc8, 0x19, 0xa7, 0xe7,
            0xc2, 0x40, 0xc3, 0xc4, 0xf7, 0xa9, 0x17, 0x32, 0xe3, 0xff, 0x13, 0xe2, 0xa5, 0x6a, 0x64, 0x66, 0x66, 0x10,
            0xca, 0xd9, 0x84, 0x1c, 0x1a, 0x93, 0x4f, 0xe9, 0x33, 0xb0, 0xf1, 0x9f, 0xb7, 0x1d, 0x06, 0x1c, 0x58, 0xf2,
            0x1a, 0x49, 0x81, 0xce, 0x3e, 0x68, 0xc5, 0x02, 0x39, 0x03, 0x60, 0x8d, 0xe5, 0x83, 0x02, 0xc6, 0xc8, 0xde,
            0xf4, 0xe5, 0x61, 0x9e, 0xc0, 0xd9, 0x1c, 0xf9, 0x35, 0x44, 0x75, 0x97, 0x2b, 0xfe, 0x0d, 0x75, 0x75, 0x60,
            0x2a, 0xaf, 0x0e, 0x9e, 0x88, 0x5c, 0x6b, 0xaf, 0x9d, 0x56, 0x7b, 0x1f, 0xcb, 0x63, 0x19, 0x0c, 0xb7, 0x92,
            0xf1, 0xd8, 0x71, 0x61, 0x1a, 0xdb, 0x4f, 0x3d, 0x1e, 0xd3, 0x28, 0x02, 0x69, 0x18, 0xe2, 0x8d, 0x2f, 0xd4,
            0x5a, 0xb9, 0xd3, 0x70, 0xe7, 0x29, 0x2e, 0xd7, 0x54, 0xce, 0x29, 0xfb, 0x78, 0x7f, 0xd5, 0xd0, 0x9e, 0x6d,
            0x47, 0xcb, 0xc8, 0x00, 0x21, 0xab, 0xf7, 0xd2, 0xef, 0xeb, 0xdb, 0xe0, 0xad, 0xd8, 0x70, 0x16, 0x8f, 0x51,
            0xdc, 0xc4, 0x09, 0x57, 0xa4, 0xa3, 0xc8, 0xe1, 0x92, 0x60, 0x13, 0x83, 0xb7, 0x68, 0x41, 0x36, 0xdc, 0xa2,
            0x82, 0x62, 0x3f, 0x31, 0xba, 0x7a, 0xe5, 0x36, 0x6b, 0x45, 0x3c, 0x6a, 0x26, 0xf6, 0x8a, 0x14, 0xdb, 0x65,
            0x59, 0xbc, 0xb1, 0x02, 0x37, 0x37, 0x9a, 0x27, 0xa9, 0x50, 0x2f, 0xf9, 0xd6, 0x4a, 0x33, 0x83, 0x20, 0x75,
            0x15, 0x30, 0xf1, 0xf8, 0x92, 0xa6, 0xd4, 0x6f, 0x50, 0x31, 0x1b, 0x5e, 0x18, 0xf0, 0x33, 0x6f, 0xc4, 0x77,
            0x21, 0x56, 0x66, 0xe1, 0x88, 0x93, 0x3c, 0x69, 0x39, 0x98, 0x9f, 0x6e, 0x6a, 0x3a, 0xdb, 0xa2, 0x29, 0x96,
            0xaa, 0xe6, 0xa0, 0xfe, 0x1b, 0xdd, 0xcb, 0xe1, 0x49, 0x6d, 0x96, 0x8d, 0xe0, 0x93, 0xdf, 0x44, 0xa3, 0x30,
            0x0f, 0x75, 0x15, 0xa1, 0x2c, 0x9d, 0x82, 0x22, 0x6d, 0x6b, 0x4d, 0x62, 0xc4, 0x6a, 0x21, 0x3d, 0x5f, 0x01,
            0x07, 0x10, 0x6f, 0xd2, 0xa2, 0x2d, 0x3b, 0x59, 0x86, 0x13, 0xdb, 0x49, 0x1f, 0x70, 0xcc, 0xb1, 0xf0, 0x3b,
            0x86, 0x59, 0x66, 0x9e, 0xd7, 0x44, 0x34, 0xe4, 0x3b, 0x77, 0x1f, 0x22, 0x78, 0x07, 0x10, 0xfb, 0xd8, 0xf2,
            0xf2, 0x0e, 0x98, 0x97, 0xdf, 0x5c, 0xc2, 0x35, 0x48, 0x77, 0x9c, 0x6c, 0x08, 0x30, 0x83, 0x9d, 0x23, 0x1c,
            0x3f, 0xf9, 0xac, 0x54, 0x40, 0x7d, 0xfd, 0xfc, 0xc5, 0x90, 0x14, 0xbf, 0x67, 0xd9, 0x68, 0x57, 0x06, 0xa5,
            0x62, 0x2e, 0x38, 0xf7, 0xa9, 0x33, 0xc3, 0x4a, 0xfb, 0xb6, 0xaa, 0x8c, 0xdf, 0xd9, 0x3b, 0xd2, 0xec, 0x91,
            0xad, 0x37, 0x90, 0x4c, 0xe1, 0x3b, 0x8a, 0xb8, 0xef, 0x77, 0x23, 0x66, 0xfa, 0xd3, 0xc3, 0xeb, 0xee, 0x8f,
            0x26, 0x11, 0xee, 0x7b, 0x6c, 0x2a, 0xf7, 0xe6, 0x53, 0xef, 0xbe, 0xc4, 0xdc, 0x4c, 0xbf, 0x13, 0xac, 0xf3,
            0x7e, 0x39, 0x9e, 0x2b, 0x0b, 0x05, 0xb6, 0x1c, 0xb7, 0xe1, 0x7b, 0x15, 0x62, 0x7b, 0x62, 0x96, 0x2e, 0x21,
            0x00, 0xb1, 0x95, 0xfe, 0xfe, 0x94, 0xbc, 0x48, 0x4e, 0x88, 0x13, 0x97, 0x00, 0x73, 0x7d, 0xe1, 0xa5, 0xec,
            0x7d, 0x9c, 0xc8, 0x5d, 0x53, 0x3b, 0x61, 0xec, 0xad, 0x86, 0x53, 0xce, 0xdb, 0xb7, 0x71, 0xf6, 0x75, 0xaf,
            0x61, 0xe4, 0xc6, 0xf7, 0xef, 0xaa, 0xcc, 0x9f, 0x7e, 0x42, 0x4c, 0x16, 0x71, 0x5b, 0x0a, 0x98, 0xc4, 0x46,
            0x05, 0x9a, 0x27, 0x1a, 0x27, 0xbd, 0x56, 0x9d, 0x1b, 0x5d, 0xbf, 0xae, 0x8f, 0x53, 0x89, 0x85, 0x24, 0xca,
            0xe8, 0x70, 0x59, 0xff, 0x34, 0xfb, 0x2a, 0x53, 0x32, 0x26, 0xbd, 0x29, 0xa0, 0xba, 0x6f, 0x8d, 0x08, 0x36,
            0xfd, 0x0a, 0x4c, 0x0d, 0x60, 0x9a, 0x72, 0xe1, 0x05, 0x39, 0xa4, 0x4f, 0x8c, 0x39, 0xf6, 0x27, 0x9b, 0xe3,
            0x96, 0xe4, 0x1c, 0xa9, 0xf2, 0x9a, 0x28, 0xce, 0x9f, 0xa0, 0xdd, 0x51, 0xa3, 0x02, 0xe7, 0x70, 0xe1, 0xe3,
            0xdb, 0x70, 0x6a, 0x34, 0xcb, 0x90, 0x4e, 0xf0, 0x8d, 0x9c, 0x82, 0xc5, 0x5b, 0xc7, 0x28, 0xc9, 0x55, 0xb1,
            0x20, 0xbb, 0x2e, 0xc3, 0x73, 0xfc, 0xff, 0xff, 0x3c, 0x46, 0xd6, 0x03, 0xab, 0x38, 0x78, 0x96, 0xd4, 0x9c,
            0xd2, 0x1b, 0x2f, 0x77, 0xec, 0xfb, 0xbb, 0x02, 0xa5, 0xe1, 0x53, 0xb1, 0x71, 0xaf, 0xed, 0x98, 0x6c, 0x15,
            0xda, 0x6f, 0x2d, 0x4c, 0xf7, 0x45, 0xd1, 0x99, 0x5f, 0x51, 0x36, 0xe1, 0xb3, 0xe6, 0x8a, 0x67, 0xa8, 0x99,
            0x6f, 0xe7, 0x65, 0x61, 0x6d, 0x8a, 0xa1, 0x1b, 0xcd, 0x9f, 0x8b, 0x59, 0x1d, 0xb8, 0x7e, 0xfc, 0xda, 0xaf,
            0xfd, 0x41, 0x00, 0x3e, 0xc7, 0x29, 0x36, 0x05, 0x42, 0x62, 0x08, 0x54, 0xfb, 0x04, 0xb8, 0x0c, 0xb8, 0x61,
            0xa6, 0x36, 0xa4, 0x71, 0x7d, 0x66, 0x68, 0x94, 0xc3, 0x2f, 0x1f, 0x2b, 0xf2, 0x24, 0x7c, 0xc4, 0x15, 0xde,
            0x1d, 0x0c, 0x4e, 0x71, 0x2b, 0x95, 0x88, 0x42, 0xd6, 0xa4, 0xb2, 0x76, 0xde, 0xa5, 0xdb, 0x88, 0x42, 0x3f,
            0x2b, 0x4c, 0x66, 0x4b, 0x1d, 0x2b, 0x18, 0x77, 0xba, 0xf3, 0x37, 0x47, 0x34, 0x36, 0x14, 0xe5, 0xeb, 0xe9,
            0xb7, 0xe1, 0x2e, 0xd0, 0x15, 0x3f, 0x9c, 0xa7, 0x45, 0x8e, 0x4d, 0xa4, 0x97, 0x63, 0x9d, 0xff, 0x13, 0x52,
            0xff, 0x0e, 0xfa, 0xe0, 0x1d, 0x14, 0x03, 0x21, 0xc2, 0x8d, 0xd0, 0xb6, 0x7b, 0x06, 0x98, 0x90, 0xf6, 0x13,
            0x0f, 0x82, 0x46, 0xab, 0x85, 0x44, 0x71, 0x75, 0x32, 0xd3, 0xa5, 0xf6, 0x36, 0x39, 0xa9, 0x9d, 0x7f, 0x8e,
            0x98, 0x31, 0xc6, 0x48, 0x51, 0xb7, 0xef, 0x68, 0x93, 0xb3, 0xc9, 0x74, 0x0f, 0x98, 0x44, 0xd1, 0x8a, 0x61,
            0x3b, 0x5f, 0x9a, 0x6a, 0xb4, 0xbd, 0x6e, 0x6a, 0x93, 0xe8, 0xe4, 0xbe, 0xa5, 0x57, 0x5d, 0x2c, 0xb4, 0x33,
            0x0c, 0x0a, 0xf8, 0x55, 0x83, 0x19, 0xa9, 0x09, 0xa5, 0x98, 0x8a, 0x99, 0x2e, 0x40, 0x63, 0x43, 0xdd, 0x1c,
            0x74, 0x2d, 0x64, 0xcd, 0x4a, 0x17, 0xa2, 0xf3, 0x79, 0x5e, 0x8d, 0xb4, 0xd3, 0x0c, 0xcd, 0xf4, 0x41, 0x56,
            0x55, 0xed, 0xa7, 0xb4, 0x37, 0xe3, 0x39, 0x73, 0x23, 0x89, 0x6b, 0x11, 0xb1, 0xbe, 0xd7, 0x2d, 0x63, 0xe3,
            0x10, 0xaa, 0x49, 0x67, 0x1d, 0x85, 0x53, 0x4f, 0x6d, 0xbc, 0x18, 0x1f, 0xeb, 0xb5, 0xbd, 0xc0, 0x8a, 0xc0,
            0xd1, 0x23, 0x82, 0x9d, 0x10, 0x8c, 0xd2, 0x69, 0xf3, 0xb0, 0xa3, 0x96, 0xf4, 0x24, 0x1e, 0x7d, 0xda, 0x72,
            0xf5, 0x48, 0x62, 0xbe, 0xde, 0xf0, 0x1c, 0x12, 0xe3, 0xc6, 0xcf, 0xdf, 0x75, 0xf6, 0x76, 0xc2, 0xdd, 0xef,
            0x91, 0xaf, 0x7f, 0x8a, 0x8a, 0x76, 0x9c, 0x25, 0xe1, 0x77, 0xcd, 0x43, 0x0b, 0xed, 0xe7, 0x4b, 0x57, 0x69,
            0x05, 0x19, 0xa9, 0x8d, 0xb1, 0xfb, 0x5c, 0x36, 0x12, 0x80, 0xf7, 0x54, 0x0a, 0xc8, 0x27, 0xa9, 0x1b, 0x2d,
            0x08, 0x75, 0x2d, 0xec, 0xfb, 0x71, 0x56, 0xfc, 0xdb, 0x61, 0x75, 0x78, 0xb0, 0x53, 0xee, 0xe4, 0x1f, 0x66,
            0xa6, 0x0e, 0x04, 0x5c, 0x3a, 0x56, 0x9f, 0x3f, 0x7e, 0xdb, 0x76, 0x31, 0x68, 0x2f, 0xde, 0x9e, 0xf9, 0x1e,
            0xa8, 0x81, 0x1f, 0xc2, 0xc7, 0x8f, 0x64, 0x6a, 0xf6, 0xb4, 0x71, 0x0e, 0xdb, 0xb8, 0xbf, 0x23, 0x28, 0xbd,
            0x32, 0x73, 0xa2, 0xcb, 0x72, 0xff, 0xcc, 0xa7, 0xc2, 0x17, 0xb8, 0x27, 0x19, 0x2d, 0xd2, 0xea, 0x92, 0x9e,
            0x97, 0x6d, 0x13, 0x1c, 0x9d, 0x20, 0x2e, 0xc5, 0x06, 0xa3, 0x5d, 0x93, 0xab, 0x21, 0x6f, 0x64, 0xbd, 0x73,
            0xfe, 0x5d, 0x8a, 0xba, 0xe4, 0x57, 0x1f, 0x85, 0xbe, 0xb8, 0x4a, 0x7f, 0x93, 0xa3, 0xde, 0x37, 0xa4, 0x51,
            0xf3, 0x08, 0xf7, 0xde, 0x6c, 0xcd, 0x1a, 0x6e, 0xef, 0xef, 0x24, 0x69, 0x9f, 0x21, 0x58, 0xd1, 0x26, 0x1f,
            0xe2, 0x51, 0x82, 0xb5, 0x02, 0xda, 0x3e, 0x74, 0x61, 0x1a, 0x61, 0x16, 0xfc, 0x30, 0x64, 0xfa, 0x72, 0x3c,
            0x5a, 0x81, 0xad, 0xc0, 0xa3, 0x2f, 0x1e, 0xd6, 0x29, 0x91, 0x57, 0xd1, 0xc1, 0x1c, 0x0a, 0xd9, 0x90, 0x41,
            0x89, 0x46, 0x96, 0x30, 0x1d, 0x5b, 0x3f, 0x1b, 0xf4, 0x32, 0x05, 0xd7, 0xdc, 0xcf, 0xa6, 0x8b, 0xbb, 0x4a,
            0x1f, 0x5e, 0x24, 0x2b, 0x3e, 0x69, 0x0b, 0xfc, 0x97, 0xb9, 0x43, 0x66, 0xa3, 0x43, 0xf5, 0xdd, 0x16, 0xdf,
            0x67, 0xb2, 0xed, 0x2b, 0xe2, 0x1c, 0x74, 0x71, 0x18, 0x87, 0x2b, 0x46, 0x2e, 0xe2, 0x0c, 0x77, 0x8c, 0xed,
            0x85, 0x6f, 0xa9, 0x80, 0x40, 0x3f, 0xb2, 0x4b, 0x78, 0x61, 0x37, 0xd0, 0xef, 0x02, 0x78, 0x53, 0x9b, 0x00,
            0xce, 0x6e, 0x23, 0xc0, 0x7e, 0xf2, 0xa0, 0x7c, 0xb2, 0x4c, 0x51, 0xc5, 0xb4, 0x85, 0xe4, 0x54, 0xed, 0xf6,
            0x61, 0xdb, 0x4b, 0x93, 0x1a, 0xb8, 0xcb, 0x49, 0x4e, 0xb3, 0x94, 0xfd, 0x13, 0xc1, 0xb3, 0x20, 0x85, 0xf2,
            0x7b, 0x20, 0x4a, 0x4b, 0x87, 0xee, 0x6c, 0x80, 0x63, 0x45, 0xd7, 0x58, 0x4c, 0xb1, 0x61, 0x00, 0x6a, 0xd9,
            0x84, 0x8a, 0x24, 0xa2, 0x2a, 0x57, 0x71, 0xe3, 0xa2, 0xab, 0x65, 0x46, 0x3f, 0x55, 0x3d, 0x52, 0xcd, 0x53,
            0x5e, 0xf1, 0x0b, 0xdd, 0x40, 0xd8, 0x87, 0x73, 0x72, 0xa5, 0x32, 0xe3, 0x73, 0x1b, 0x0e, 0xe9, 0x0c, 0x04,
            0xe8, 0xe4, 0x37, 0x47, 0xcc, 0x3e, 0xb9, 0x6b, 0xb8, 0x79, 0xbd, 0x94, 0xd7, 0x01, 0x2a, 0xf4, 0x6a, 0x93,
            0xba, 0x17, 0x70, 0x37, 0xf0, 0x62, 0x74, 0x4d, 0x3f, 0xdf, 0xcc, 0xd3, 0x6a, 0xab, 0xe0, 0xf8, 0xcc, 0xca,
            0x19, 0xdc, 0xf7, 0x84, 0x1b, 0x1e, 0xe2, 0xf4, 0xfe, 0xb1, 0x80, 0x0e, 0x75, 0x44, 0x1c, 0x51, 0xe9, 0x5c,
            0xce, 0x94, 0xce, 0xee, 0xcd, 0x85, 0x87, 0xfb, 0xf5, 0x74, 0x30, 0x8d, 0xd7, 0x63, 0x63, 0x1b, 0x73, 0x35,
            0x78, 0x30, 0x91, 0xf4, 0xc8, 0xb3, 0xc8, 0xfb, 0x3c, 0xd9, 0x39, 0x70, 0xce, 0xf0, 0xed, 0xa4, 0xca, 0x08,
            0x44, 0x75, 0x68, 0x23, 0x9c, 0x02, 0xfe, 0x8f, 0x67, 0x5e, 0x15, 0xc4, 0x9b, 0x51, 0x21, 0xb1, 0x00, 0xcc,
            0x19, 0xfc, 0xc2, 0xb2, 0x91, 0x3d, 0xf7, 0x4f, 0x75, 0x8f, 0x70, 0xbd, 0x6e, 0xeb, 0x73, 0x39, 0x51, 0x6e,
            0x5f, 0x1e, 0xff, 0x97, 0x00, 0xf8, 0xee, 0x13, 0x0e, 0x5c, 0x84, 0xce, 0xd7, 0xb1, 0xce, 0xd6, 0x6b, 0xe9,
            0xa0, 0x55, 0x96, 0xbe, 0x8e, 0x55, 0xf6, 0xd9, 0xfd, 0xf7, 0xcf, 0x0f, 0xa6, 0x22, 0x90, 0xec, 0x67, 0x0b,
            0x6b, 0xdd, 0x67, 0x38, 0xbb, 0x5c, 0xfb, 0x34, 0x1e, 0xf5, 0xff, 0xb4, 0x2b, 0xc2, 0xab, 0xc5, 0x08, 0xff,
            0x23, 0x12, 0x48, 0xf2, 0xc2, 0xdc, 0x15, 0x77, 0x0d, 0x33, 0x72, 0x2b, 0x9c, 0x9d, 0xae,
        ];
        let script_code = vec![0xac, 0x65];
        let input_index = 0;
        let hash_type = 3;
        let amount = 391892287957268;
        let consensus_branch_id = 1991772603;
        let expected_sighash = H256::from([
            0x6a, 0x3b, 0x2b, 0xcc, 0x15, 0x57, 0x89, 0xa2, 0x74, 0x39, 0xaa, 0x27, 0x5c, 0xa9, 0x9e, 0xc6, 0x48, 0xdd,
            0xd5, 0x88, 0xe8, 0x2e, 0xfa, 0xe4, 0xac, 0x46, 0xba, 0x3f, 0xd0, 0xe3, 0xbb, 0xa0,
        ]);
        let tx: Transaction = deserialize(tx.as_slice()).unwrap();
        let mut signer = TransactionInputSigner::from(tx);
        signer.inputs[0].amount = amount;
        signer.consensus_branch_id = consensus_branch_id;

        let sig_hash = signer.signature_hash(
            input_index,
            amount,
            &script_code.into(),
            SignatureVersion::Base,
            hash_type,
        );

        assert_eq!(expected_sighash, sig_hash);
    }

    #[test]
    fn test_sapling_sig_hash_none() {
        let tx = vec![
            0x04, 0x00, 0x00, 0x80, 0x85, 0x20, 0x2f, 0x89, 0x02, 0x0b, 0xbe, 0x32, 0xa5, 0x98, 0xc2, 0x2a, 0xdf, 0xb4,
            0x8c, 0xef, 0x72, 0xba, 0x5d, 0x42, 0x87, 0xc0, 0xce, 0xfb, 0xac, 0xfd, 0x8c, 0xe1, 0x95, 0xb4, 0x96, 0x3c,
            0x34, 0xa9, 0x4b, 0xba, 0x7a, 0x17, 0x5d, 0xae, 0x4b, 0x04, 0x65, 0xac, 0x65, 0x63, 0x53, 0x70, 0x89, 0x15,
            0x09, 0x0f, 0x47, 0xa0, 0x68, 0xe2, 0x27, 0x43, 0x3f, 0x9e, 0x49, 0xd3, 0xaa, 0x09, 0xe3, 0x56, 0xd8, 0xd6,
            0x6d, 0x0c, 0x01, 0x21, 0xe9, 0x1a, 0x3c, 0x4a, 0xa3, 0xf2, 0x7f, 0xa1, 0xb6, 0x33, 0x96, 0xe2, 0xb4, 0x1d,
            0x09, 0x00, 0x63, 0x53, 0x53, 0x00, 0xac, 0x53, 0xac, 0x51, 0x4e, 0x97, 0x05, 0x68, 0x02, 0xda, 0x07, 0x1b,
            0x97, 0x0d, 0x48, 0x07, 0x00, 0x01, 0x52, 0xa8, 0x44, 0x55, 0x0b, 0xdc, 0x20, 0x02, 0x00, 0x07, 0x52, 0x52,
            0x6a, 0x65, 0x52, 0x00, 0x52, 0xd7, 0x03, 0x43, 0x02, 0x01, 0x1b, 0x9a, 0x07, 0x66, 0x20, 0xed, 0xc0, 0x67,
            0xff, 0x02, 0x00, 0x00, 0x03, 0x53, 0xe3, 0xb8, 0xa7, 0x1f, 0xac, 0xe1, 0xc9, 0xf3, 0x77, 0x45, 0xed, 0x36,
            0x88, 0x35, 0x29, 0x30, 0x4b, 0xfd, 0x5a, 0x39, 0x0b, 0x37, 0xbc, 0x5a, 0x34, 0x45, 0x24, 0x1f, 0x03, 0xf6,
            0x4a, 0x81, 0x88, 0x20, 0xdf, 0xed, 0xdd, 0x75, 0x37, 0x51, 0x59, 0xfb, 0xd2, 0x1e, 0xca, 0x98, 0x72, 0x10,
            0x4f, 0x8d, 0x7b, 0x3c, 0x8c, 0x86, 0x97, 0x03, 0xa1, 0xe7, 0x84, 0x8a, 0x5c, 0x94, 0x1e, 0x45, 0xa9, 0xc7,
            0x94, 0x34, 0x46, 0xd0, 0xdc, 0x96, 0x27, 0xcb, 0x31, 0xf8, 0x0e, 0x7a, 0xa5, 0x96, 0xd4, 0x82, 0x1d, 0xc9,
            0x9a, 0x7d, 0x77, 0x7c, 0xd5, 0x7e, 0x19, 0x48, 0x42, 0xa0, 0x23, 0x47, 0x1f, 0x0f, 0x62, 0x88, 0xa1, 0x50,
            0x64, 0x7b, 0x2a, 0xfe, 0x9d, 0xf7, 0xcc, 0xcf, 0x01, 0xf5, 0xcd, 0xe5, 0xf0, 0x46, 0x80, 0xbb, 0xfe, 0xd8,
            0x7f, 0x6c, 0xf4, 0x29, 0xfb, 0x27, 0xad, 0x6b, 0xab, 0xe7, 0x91, 0x76, 0x66, 0x11, 0xcf, 0x5b, 0xc2, 0x0e,
            0x48, 0xbe, 0xf1, 0x19, 0x25, 0x9b, 0x9b, 0x8a, 0x0e, 0x39, 0xc3, 0xdf, 0x28, 0xcb, 0x95, 0x82, 0xea, 0x33,
            0x86, 0x01, 0xcd, 0xc4, 0x81, 0xb3, 0x2f, 0xb8, 0x2a, 0xde, 0xeb, 0xb3, 0xda, 0xde, 0x25, 0xd1, 0xa3, 0xdf,
            0x20, 0xc3, 0x7e, 0x71, 0x25, 0x06, 0xb5, 0xd9, 0x96, 0xc4, 0x9a, 0x9f, 0x0f, 0x30, 0xdd, 0xcb, 0x91, 0xfe,
            0x90, 0x04, 0xe1, 0xe8, 0x32, 0x94, 0xa6, 0xc9, 0x20, 0x3d, 0x94, 0xe8, 0xdc, 0x2c, 0xbb, 0x44, 0x9d, 0xe4,
            0x15, 0x50, 0x32, 0x60, 0x4e, 0x47, 0x99, 0x70, 0x16, 0xb3, 0x04, 0xfd, 0x43, 0x7d, 0x82, 0x35, 0x04, 0x5e,
            0x25, 0x5a, 0x19, 0xb7, 0x43, 0xa0, 0xa9, 0xf2, 0xe3, 0x36, 0xb4, 0x4c, 0xae, 0x30, 0x7b, 0xb3, 0x98, 0x7b,
            0xd3, 0xe4, 0xe7, 0x77, 0xfb, 0xb3, 0x4c, 0x0a, 0xb8, 0xcc, 0x3d, 0x67, 0x46, 0x6c, 0x0a, 0x88, 0xdd, 0x4c,
            0xca, 0xd1, 0x8a, 0x07, 0xa8, 0xd1, 0x06, 0x8d, 0xf5, 0xb6, 0x29, 0xe5, 0x71, 0x8d, 0x0f, 0x6d, 0xf5, 0xc9,
            0x57, 0xcf, 0x71, 0xbb, 0x00, 0xa5, 0x17, 0x8f, 0x17, 0x5c, 0xac, 0xa9, 0x44, 0xe6, 0x35, 0xc5, 0x15, 0x9f,
            0x73, 0x8e, 0x24, 0x02, 0xa2, 0xd2, 0x1a, 0xa0, 0x81, 0xe1, 0x0e, 0x45, 0x6a, 0xfb, 0x00, 0xb9, 0xf6, 0x24,
            0x16, 0xc8, 0xb9, 0xc0, 0xf7, 0x22, 0x8f, 0x51, 0x07, 0x29, 0xe0, 0xbe, 0x3f, 0x30, 0x53, 0x13, 0xd7, 0x7f,
            0x73, 0x79, 0xdc, 0x2a, 0xf2, 0x48, 0x69, 0xc6, 0xc7, 0x4e, 0xe4, 0x47, 0x14, 0x98, 0x86, 0x1d, 0x19, 0x2f,
            0x0f, 0xf0, 0xf5, 0x08, 0x28, 0x5d, 0xab, 0x6b, 0x6a, 0x36, 0xcc, 0xf7, 0xd1, 0x22, 0x56, 0xcc, 0x76, 0xb9,
            0x55, 0x03, 0x72, 0x0a, 0xc6, 0x72, 0xd0, 0x82, 0x68, 0xd2, 0xcf, 0x77, 0x73, 0xb6, 0xba, 0x2a, 0x5f, 0x66,
            0x48, 0x47, 0xbf, 0x70, 0x7f, 0x2f, 0xc1, 0x0c, 0x98, 0xf2, 0xf0, 0x06, 0xec, 0x22, 0xcc, 0xb5, 0xa8, 0xc8,
            0xb7, 0xc4, 0x0c, 0x7c, 0x2d, 0x49, 0xa6, 0x63, 0x9b, 0x9f, 0x2c, 0xe3, 0x3c, 0x25, 0xc0, 0x4b, 0xc4, 0x61,
            0xe7, 0x44, 0xdf, 0xa5, 0x36, 0xb0, 0x0d, 0x94, 0xba, 0xdd, 0xf4, 0xf4, 0xd1, 0x40, 0x44, 0xc6, 0x95, 0xa3,
            0x38, 0x81, 0x47, 0x7d, 0xf1, 0x24, 0xf0, 0xfc, 0xf2, 0x06, 0xa9, 0xfb, 0x2e, 0x65, 0xe3, 0x04, 0xcd, 0xbf,
            0x0c, 0x4d, 0x23, 0x90, 0x17, 0x0c, 0x13, 0x0a, 0xb8, 0x49, 0xc2, 0xf2, 0x2b, 0x5c, 0xdd, 0x39, 0x21, 0x64,
            0x0c, 0x8c, 0xf1, 0x97, 0x6a, 0xe1, 0x01, 0x0b, 0x0d, 0xfd, 0x9c, 0xb2, 0x54, 0x3e, 0x45, 0xf9, 0x97, 0x49,
            0xcc, 0x4d, 0x61, 0xf2, 0xe8, 0xaa, 0xbf, 0xe9, 0x8b, 0xd9, 0x05, 0xfa, 0x39, 0x95, 0x1b, 0x33, 0xea, 0x76,
            0x9c, 0x45, 0xab, 0x95, 0x31, 0xc5, 0x72, 0x09, 0x86, 0x2a, 0xd1, 0x2f, 0xd7, 0x6b, 0xa4, 0x80, 0x7e, 0x65,
            0x41, 0x7b, 0x6c, 0xd1, 0x2f, 0xa8, 0xec, 0x91, 0x6f, 0x01, 0x3e, 0xbb, 0x87, 0x06, 0xa9, 0x6e, 0xff, 0xed,
            0xa0, 0x6c, 0x4b, 0xe2, 0x4b, 0x04, 0x84, 0x63, 0x92, 0xe9, 0xd1, 0xe6, 0x93, 0x0e, 0xae, 0x01, 0xfa, 0x21,
            0xfb, 0xd7, 0x00, 0x58, 0x3f, 0xb5, 0x98, 0xb9, 0x2c, 0x8f, 0x4e, 0xb8, 0xa6, 0x1a, 0xa6, 0x23, 0x5d, 0xb6,
            0x0f, 0x28, 0x41, 0xcf, 0x3a, 0x1c, 0x6a, 0xb5, 0x4c, 0x67, 0x06, 0x68, 0x44, 0x71, 0x1d, 0x09, 0x1e, 0xb9,
            0x31, 0xa1, 0xbd, 0x62, 0x81, 0xae, 0xdf, 0x2a, 0x0e, 0x8f, 0xab, 0x18, 0x81, 0x72, 0x02, 0xa9, 0xbe, 0x06,
            0x40, 0x2e, 0xd9, 0xcc, 0x72, 0x0c, 0x16, 0xbf, 0xe8, 0x81, 0xe4, 0xdf, 0x42, 0x55, 0xe8, 0x7a, 0xfb, 0x7f,
            0xc6, 0x2f, 0x38, 0x11, 0x6b, 0xbe, 0x03, 0xcd, 0x8a, 0x3c, 0xb1, 0x1a, 0x27, 0xd5, 0x68, 0x41, 0x47, 0x82,
            0xf4, 0x7b, 0x1a, 0x44, 0xc9, 0x7c, 0x68, 0x04, 0x67, 0x69, 0x4b, 0xc9, 0x70, 0x9d, 0x32, 0x91, 0x6c, 0x97,
            0xe8, 0x00, 0x6c, 0xbb, 0x07, 0xba, 0x0e, 0x41, 0x80, 0xa3, 0x73, 0x80, 0x38, 0xc3, 0x74, 0xc4, 0xcc, 0xe8,
            0xf3, 0x29, 0x59, 0xaf, 0xb2, 0x5f, 0x30, 0x3f, 0x58, 0x15, 0xc4, 0x53, 0x31, 0x24, 0xac, 0xf9, 0xd1, 0x89,
            0x40, 0xe7, 0x75, 0x22, 0xac, 0x5d, 0xc4, 0xb9, 0x57, 0x0a, 0xae, 0x8f, 0x47, 0xb7, 0xf5, 0x7f, 0xd8, 0x76,
            0x7b, 0xea, 0x1a, 0x24, 0xae, 0x7b, 0xed, 0x65, 0xb4, 0xaf, 0xdc, 0x8f, 0x12, 0x78, 0xc3, 0x0e, 0x2d, 0xb9,
            0x8f, 0xd1, 0x72, 0x73, 0x0a, 0xc6, 0xbb, 0xed, 0x4f, 0x11, 0x27, 0xcd, 0x32, 0xb0, 0x4a, 0x95, 0xb2, 0x05,
            0x52, 0x6c, 0xfc, 0xb4, 0xc4, 0xe1, 0xcc, 0x95, 0x51, 0x75, 0xb3, 0xe8, 0xde, 0x1f, 0x5d, 0x81, 0xb1, 0x86,
            0x69, 0x69, 0x23, 0x50, 0xaa, 0xa1, 0xa1, 0xd7, 0x97, 0x61, 0x75, 0x82, 0xe5, 0x4d, 0x7a, 0x5b, 0x57, 0xa6,
            0x83, 0xb3, 0x2f, 0xb1, 0x09, 0x80, 0x62, 0xda, 0xd7, 0xb0, 0xc2, 0xeb, 0x51, 0x8f, 0x68, 0x62, 0xe8, 0x3d,
            0xb2, 0x5e, 0x3d, 0xba, 0xf7, 0xae, 0xd5, 0x04, 0xde, 0x93, 0x2a, 0xcb, 0x99, 0xd7, 0x35, 0x99, 0x2c, 0xe6,
            0x2b, 0xae, 0x9e, 0xf8, 0x93, 0xff, 0x6a, 0xcc, 0x0f, 0xfc, 0xf8, 0xe3, 0x48, 0x3e, 0x14, 0x6b, 0x9d, 0x49,
            0xdd, 0x8c, 0x78, 0x35, 0xf4, 0x3a, 0x37, 0xdc, 0xa0, 0x78, 0x7e, 0x3e, 0xc9, 0xf6, 0x60, 0x52, 0x23, 0xd5,
            0xba, 0x7a, 0xe0, 0xab, 0x90, 0x25, 0xb7, 0x3b, 0xc0, 0x3f, 0x7f, 0xac, 0x36, 0xc0, 0x09, 0xa5, 0x6d, 0x4d,
            0x95, 0xd1, 0xe8, 0x1d, 0x3b, 0x3e, 0xbc, 0xa7, 0xe5, 0x4c, 0xc1, 0xa1, 0x2d, 0x12, 0x7b, 0x57, 0xc8, 0x13,
            0x89, 0x76, 0xe7, 0x91, 0x01, 0x3b, 0x01, 0x5f, 0x06, 0xa6, 0x24, 0xf5, 0x21, 0xb6, 0xee, 0x04, 0xec, 0x98,
            0x08, 0x93, 0xc7, 0xe5, 0xe0, 0x1a, 0x33, 0x62, 0x03, 0x59, 0x40, 0x94, 0xf8, 0x28, 0x33, 0xd7, 0x44, 0x27,
            0x88, 0x00, 0x84, 0xd3, 0x58, 0x63, 0xc8, 0xe7, 0xeb, 0xb5, 0xc9, 0xee, 0xd9, 0x8e, 0x72, 0x57, 0x2e, 0xc4,
            0x0c, 0x79, 0xb2, 0x66, 0x23, 0xb5, 0x80, 0x22, 0xf4, 0x89, 0xb0, 0x89, 0x3d, 0x88, 0xbe, 0x63, 0xf3, 0xf8,
            0xc0, 0xd2, 0x32, 0x49, 0xeb, 0xcd, 0xe1, 0x3d, 0xb9, 0x31, 0x29, 0x41, 0xc3, 0x6c, 0x1d, 0x1c, 0xbc, 0xab,
            0xac, 0x0c, 0x78, 0xcb, 0x3b, 0x19, 0x12, 0xdb, 0x0d, 0xcb, 0xfe, 0x18, 0x93, 0xd9, 0xb5, 0x1b, 0xe4, 0xaf,
            0x1d, 0x00, 0x0b, 0xac, 0x1a, 0xd0, 0xa3, 0xae, 0x2c, 0xe1, 0xe7, 0x32, 0x25, 0xfb, 0x11, 0x4d, 0x05, 0xaf,
            0x4c, 0xef, 0xc0, 0x6e, 0x87, 0x5f, 0x07, 0x4f, 0xfe, 0xae, 0x0c, 0xba, 0x7d, 0xa3, 0xa5, 0x16, 0xc1, 0x73,
            0xbe, 0x1c, 0x51, 0x33, 0x23, 0xe1, 0x19, 0xf6, 0x35, 0xe8, 0x20, 0x9a, 0x07, 0x4b, 0x21, 0x6b, 0x70, 0x23,
            0xfa, 0xdc, 0x2d, 0x25, 0x94, 0x9c, 0x90, 0x03, 0x7e, 0x71, 0xe3, 0xe5, 0x50, 0x72, 0x6d, 0x21, 0x0a, 0x2c,
            0x68, 0x83, 0x42, 0xe5, 0x24, 0x40, 0x63, 0x5e, 0x9c, 0xc1, 0x4a, 0xfe, 0x10, 0x10, 0x26, 0x21, 0xa9, 0xc9,
            0xac, 0xcb, 0x78, 0x2e, 0x9e, 0x4a, 0x5f, 0xa8, 0x7f, 0x0a, 0x95, 0x6f, 0x5b, 0x85, 0x50, 0x99, 0x60, 0x28,
            0x5c, 0x22, 0x62, 0x7c, 0x59, 0x48, 0x3a, 0x5a, 0x4c, 0x28, 0xcc, 0xe4, 0xb1, 0x56, 0xe5, 0x51, 0x40, 0x6a,
            0x7e, 0xe8, 0x35, 0x56, 0x56, 0xa2, 0x1e, 0x43, 0xe3, 0x8c, 0xe1, 0x29, 0xfd, 0xad, 0xb7, 0x59, 0xed, 0xdf,
            0xa0, 0x8f, 0x00, 0xfc, 0x8e, 0x56, 0x7c, 0xef, 0x93, 0xc6, 0x79, 0x2d, 0x01, 0xdf, 0x05, 0xe6, 0xd5, 0x80,
            0xf4, 0xd5, 0xd4, 0x8d, 0xf0, 0x42, 0x45, 0x1a, 0x33, 0x59, 0x0d, 0x3e, 0x8c, 0xf4, 0x9b, 0x26, 0x27, 0x21,
            0x8f, 0x0c, 0x29, 0x2f, 0xa6, 0x6a, 0xda, 0x94, 0x5f, 0xa5, 0x5b, 0xb2, 0x35, 0x48, 0xe3, 0x3a, 0x83, 0xa5,
            0x62, 0x95, 0x7a, 0x31, 0x49, 0xa9, 0x93, 0xcc, 0x47, 0x23, 0x62, 0x29, 0x87, 0x36, 0xa8, 0xb7, 0x78, 0xd9,
            0x7c, 0xe4, 0x23, 0x01, 0x3d, 0x64, 0xb3, 0x2c, 0xd1, 0x72, 0xef, 0xa5, 0x51, 0xbf, 0x7f, 0x36, 0x8f, 0x04,
            0xbd, 0xae, 0xc6, 0x09, 0x1a, 0x30, 0x04, 0xa7, 0x57, 0x59, 0x8b, 0x80, 0x1d, 0xcf, 0x67, 0x5c, 0xb8, 0x3e,
            0x43, 0xa5, 0x3a, 0xe8, 0xb2, 0x54, 0xd3, 0x33, 0xbc, 0xda, 0x20, 0xd4, 0x81, 0x7d, 0x34, 0x77, 0xab, 0xfb,
            0xa2, 0x5b, 0xb8, 0x3d, 0xf5, 0x94, 0x9c, 0x12, 0x6f, 0x14, 0x9b, 0x1d, 0x99, 0x34, 0x1e, 0x4e, 0x6f, 0x91,
            0x20, 0xf4, 0xd4, 0x1e, 0x62, 0x91, 0x85, 0x00, 0x2c, 0x72, 0xc0, 0x12, 0xc4, 0x14, 0xd2, 0x38, 0x2a, 0x6d,
            0x47, 0xc7, 0xb3, 0xde, 0xab, 0xa7, 0x70, 0xc4, 0x00, 0xca, 0x96, 0xb2, 0x81, 0x4f, 0x6b, 0x26, 0xc3, 0xef,
            0x17, 0x42, 0x9f, 0x1a, 0x98, 0xc8, 0x5d, 0x83, 0xdb, 0x20, 0xef, 0xad, 0x48, 0xbe, 0x89, 0x96, 0xfb, 0x1b,
            0xff, 0x59, 0x1e, 0xff, 0xf3, 0x60, 0xfe, 0x11, 0x99, 0x05, 0x6c, 0x56, 0xe5, 0xfe, 0xec, 0x61, 0xa7, 0xb8,
            0xb9, 0xf6, 0x99, 0xd6, 0x01, 0x2c, 0x28, 0x49, 0x23, 0x2f, 0x32, 0x9f, 0xef, 0x95, 0xc7, 0xaf, 0x37, 0x00,
            0x98, 0xff, 0xe4, 0x91, 0x8e, 0x0c, 0xa1, 0xdf, 0x47, 0xf2, 0x75, 0x86, 0x7b, 0x73, 0x9e, 0x0a, 0x51, 0x4d,
            0x32, 0x09, 0x32, 0x5e, 0x21, 0x70, 0x45, 0x92, 0x7b, 0x47, 0x9c, 0x1c, 0xe2, 0xe5, 0xd5, 0x4f, 0x25, 0x48,
            0x8c, 0xad, 0x15, 0x13, 0xe3, 0xf4, 0x4a, 0x21, 0x26, 0x6c, 0xfd, 0x84, 0x16, 0x33, 0x32, 0x7d, 0xee, 0x6c,
            0xf8, 0x10, 0xfb, 0xf7, 0x39, 0x3e, 0x31, 0x7d, 0x9e, 0x53, 0xd1, 0xbe, 0x1d, 0x5a, 0xe7, 0x83, 0x9b, 0x66,
            0xb9, 0x43, 0xb9, 0xed, 0x18, 0xf2, 0xc5, 0x30, 0xe9, 0x75, 0x42, 0x23, 0x32, 0xc3, 0x43, 0x9c, 0xce, 0x49,
            0xa2, 0x9f, 0x2a, 0x33, 0x6a, 0x48, 0x51, 0x26, 0x3c, 0x5e, 0x9b, 0xd1, 0x3d, 0x73, 0x11, 0x09, 0xe8, 0x44,
            0xb7, 0xf8, 0xc3, 0x92, 0xa5, 0xc1, 0xdc, 0xaa, 0x2a, 0xe5, 0xf5, 0x0f, 0xf6, 0x3f, 0xab, 0x97, 0x65, 0xe0,
            0x16, 0x70, 0x2c, 0x35, 0xa6, 0x7c, 0xd7, 0x36, 0x4d, 0x3f, 0xab, 0x55, 0x2f, 0xb3, 0x49, 0xe3, 0x5c, 0x15,
            0xc5, 0x02, 0x50, 0x45, 0x3f, 0xd1, 0x8f, 0x7b, 0x85, 0x59, 0x92, 0x63, 0x2e, 0x2c, 0x76, 0xc0, 0xfb, 0xf1,
            0xef, 0x96, 0x3e, 0xa8, 0x0e, 0x32, 0x23, 0xde, 0x32, 0x77, 0xbc, 0x55, 0x92, 0x51, 0x72, 0x58, 0x29, 0xec,
            0x03, 0xf2, 0x13, 0xba, 0x89, 0x55, 0xca, 0xb2, 0x82, 0x2f, 0xf2, 0x1a, 0x9b, 0x0a, 0x49, 0x04, 0xd6, 0x68,
            0xfc, 0xd7, 0x72, 0x24, 0xbd, 0xe3, 0xdd, 0x01, 0xf6, 0xff, 0xc4, 0x82, 0x8f, 0x6b, 0x64, 0x23, 0x0b, 0x35,
            0xc6, 0xa0, 0x49, 0x87, 0x34, 0x94, 0x27, 0x6e, 0xa1, 0xd7, 0xed, 0x5e, 0x92, 0xcb, 0x4f, 0x90, 0xba, 0x83,
            0xa9, 0xe4, 0x96, 0x01, 0xb1, 0x94, 0x04, 0x2f, 0x29, 0x00, 0xd9, 0x9d, 0x31, 0x2d, 0x7b, 0x70, 0x50, 0x8c,
            0xf1, 0x76, 0x06, 0x6d, 0x15, 0x4d, 0xbe, 0x96, 0xef, 0x9d, 0x43, 0x67, 0xe4, 0xc8, 0x40, 0xe4, 0xa1, 0x7b,
            0x5e, 0x51, 0x22, 0xe8, 0xeb, 0xe2, 0x15, 0x8a, 0x3c, 0x5f, 0x4c, 0xba, 0xe2, 0x1e, 0xa3, 0xfa, 0x1a, 0xe6,
            0xc2, 0x5a, 0x94, 0x62, 0xeb, 0xcb, 0xb0, 0xfd, 0x5f, 0x14, 0x55, 0x4b, 0xc9, 0x77, 0x47, 0xc3, 0x3e, 0x34,
            0xda, 0x90, 0xc8, 0x16, 0xd8, 0xd0, 0xd5, 0x0b, 0xfe, 0x37, 0x61, 0x8c, 0x58, 0x12, 0x89, 0x14, 0x84, 0xfa,
            0x25, 0x93, 0x22, 0xc1, 0x50, 0x92, 0xd4, 0x15, 0x5d, 0x86, 0x96, 0xd6, 0xf1, 0x2f, 0x24, 0xfd, 0x36, 0x44,
            0x96, 0xb3, 0xbe, 0x08, 0x71, 0xca, 0x3d, 0xd9, 0x62, 0x53, 0x48, 0xa6, 0x14, 0xb5, 0x9b, 0xde, 0x45, 0x88,
            0x56, 0x49, 0xba, 0xe3, 0x6d, 0xe3, 0x4d, 0xef, 0x8f, 0xce, 0xc8, 0x53, 0x43, 0x47, 0x5d, 0x97, 0x6a, 0xe1,
            0xe9, 0xb2, 0x78, 0x29, 0xce, 0x2a, 0xc5, 0xef, 0xd0, 0xb3, 0x99, 0xa8, 0xb4, 0x48, 0xbe, 0x65, 0x04, 0x29,
            0x4e, 0xe6, 0xb3, 0xc1, 0xc6, 0xa5, 0x34, 0x2d, 0x7c, 0x01, 0xae, 0x9d, 0x8a, 0xd3, 0x07, 0x0c, 0x2b, 0x1a,
            0x91, 0x57, 0x3a, 0xf5, 0xe0, 0xc5, 0xe4, 0xcb, 0xbf, 0x4a, 0xcd, 0xc6, 0xb5, 0x4c, 0x92, 0x72, 0x20, 0x0d,
            0x99, 0x70, 0x25, 0x0c, 0x17, 0xc1, 0x03, 0x6f, 0x06, 0x08, 0x5c, 0x41, 0x85, 0x8e, 0xd3, 0xa0, 0xc4, 0x81,
            0x50, 0xbc, 0x69, 0x7e, 0x4a, 0x69, 0x5f, 0xef, 0x33, 0x5f, 0x7a, 0xd0, 0x7e, 0x1a, 0x46, 0xdc, 0x76, 0x7f,
            0xf8, 0x22, 0xdb, 0x70, 0xe6, 0x66, 0x90, 0x80, 0xb9, 0x81, 0x6b, 0x22, 0x32, 0xc8, 0x1a, 0x4c, 0x66, 0xcc,
            0x58, 0x6a, 0xbf, 0xe1, 0xea, 0xa8, 0xca, 0x6c, 0xf4, 0x1f, 0xc3, 0x0e, 0xb8, 0xdc, 0x57, 0xc3, 0x7a, 0x3c,
            0x39, 0xc5, 0x9c, 0x94, 0x23, 0x2d, 0xf9, 0xd3, 0x88, 0xdb, 0xfa, 0x35, 0xc2, 0xcd, 0x5c, 0x75, 0xf3, 0x28,
            0xe9, 0xfe, 0xa7, 0x8f, 0x65, 0x56, 0x8f, 0x2b, 0xb9, 0x34, 0xc8, 0x2c, 0x41, 0x42, 0xda, 0x69, 0xd1, 0x2c,
            0xa7, 0xde, 0x9a, 0x7d, 0xf7, 0x06, 0x40, 0x0e, 0xc7, 0x98, 0x78, 0xd8, 0x68, 0xe1, 0x7e, 0x8f, 0x71, 0xea,
            0x31, 0x49, 0x5a, 0x8b, 0xae, 0x7b, 0xdc, 0x2e, 0x48, 0xb5, 0x11, 0x87, 0x71, 0xc2, 0xfc, 0xa0, 0x78, 0xcc,
            0xa1, 0xfc, 0xe0, 0xd7, 0xef, 0x0a, 0xf3, 0x47, 0x8c, 0xf3, 0x6f, 0x69, 0xe8, 0x5a, 0x41, 0xdd, 0x29, 0xb4,
            0x29, 0x4a, 0x65, 0xd3, 0xe0, 0x55, 0xff, 0x71, 0x8d, 0xd9, 0xdc, 0x8c, 0x75, 0xe7, 0xe5, 0xb2, 0xef, 0xe4,
            0x42, 0x63, 0x73, 0x71, 0xb7, 0xc4, 0x8f, 0x6e, 0xe9, 0x9e, 0x3e, 0xa3, 0x8a, 0x4b, 0x0f, 0x2f, 0x67, 0xfc,
            0x2b, 0x90, 0x8c, 0xda, 0x65, 0x7e, 0xae, 0x75, 0x4e, 0x03, 0x7e, 0x26, 0x2e, 0x9a, 0x9f, 0x9b, 0xd7, 0xec,
            0x42, 0x67, 0xed, 0x8e, 0x96, 0x93, 0x0e, 0x10, 0x84, 0x78, 0x3c, 0x37, 0xd6, 0xf9, 0xdd, 0x15, 0xfd, 0x29,
            0xf4, 0xcc, 0x47, 0x7e, 0x66, 0xf1, 0x30, 0xd6, 0x30, 0x43, 0x0d, 0xcc, 0x01, 0x04, 0x89, 0x9b, 0x4f, 0x9f,
            0x46, 0xeb, 0x09, 0x0e, 0xf7, 0xfc, 0x90, 0xb4, 0x79, 0xab, 0xf6, 0x1f, 0x93, 0x95, 0x5e, 0xe0, 0x0e, 0x6a,
            0x18, 0x48, 0xf1, 0xab, 0x14, 0xad, 0x33, 0x4f, 0x2b, 0x68, 0x03, 0x58, 0x08, 0xcd, 0xf1, 0xbb, 0x9e, 0x9d,
            0x9a, 0x81, 0x6b, 0xaf, 0x72, 0x8a, 0x95, 0x5b, 0x96, 0x0b, 0x77, 0x01, 0xfa, 0x62, 0x66, 0x87, 0xdc, 0x3c,
            0x9c, 0xba, 0x64, 0x63, 0x37, 0xb5, 0x3e, 0x29, 0x81, 0x6e, 0x94, 0x82, 0xdd, 0xf5, 0x57, 0x8a, 0x87, 0x68,
            0xaa, 0xe4, 0x77, 0xfc, 0xe4, 0x10, 0xac, 0x2d, 0x5d, 0xe6, 0x09, 0x58, 0x61, 0xc1, 0x11, 0xd7, 0xfe, 0xb3,
            0xe6, 0xbb, 0x4f, 0xbb, 0x5a, 0x54, 0x95, 0x54, 0x95, 0x97, 0x27, 0x98, 0x35, 0x0a, 0x25, 0x3f, 0x05, 0xf6,
            0x6c, 0x2e, 0xcf, 0xcb, 0xc0, 0xed, 0x43, 0xf5, 0xec, 0x2e, 0x6d, 0x8d, 0xba, 0x15, 0xa5, 0x12, 0x54, 0xd9,
            0x7b, 0x18, 0x21, 0x10, 0x7c, 0x07, 0xdd, 0x9a, 0x16, 0xef, 0x84, 0x06, 0xf9, 0x43, 0xe2, 0x82, 0xb9, 0x5d,
            0x4b, 0x36, 0x25, 0x30, 0xc9, 0x13, 0xd6, 0xba, 0x42, 0x1d, 0xf6, 0x02, 0x7d, 0xe5, 0xaf, 0x1e, 0x47, 0x45,
            0xd5, 0x86, 0x81, 0x06, 0x95, 0x4b, 0xe6, 0xc1, 0x96, 0x27, 0x80, 0xa2, 0x94, 0x10, 0x72, 0xe9, 0x51, 0x31,
            0xb1, 0x67, 0x9d, 0xf0, 0x63, 0x76, 0x25, 0x04, 0x2c, 0x37, 0xd4, 0x8f, 0xfb, 0x15, 0x2e, 0x5e, 0xbc, 0x18,
            0x5c, 0x8a, 0x2b, 0x7d, 0x43, 0x85, 0xf1, 0xc9, 0x5a, 0xf9, 0x37, 0xdf, 0x78, 0xdf, 0xd8, 0x75, 0x7f, 0xab,
            0x43, 0x49, 0x68, 0xb0, 0xb5, 0x7c, 0x66, 0x57, 0x44, 0x68, 0xf1, 0x60, 0xb4, 0x47, 0xac, 0x82, 0x21, 0xe5,
            0x06, 0x06, 0x76, 0xa8, 0x42, 0xa1, 0xc6, 0xb7, 0x17, 0x2d, 0xd3, 0x34, 0x0f, 0x76, 0x40, 0x70, 0xab, 0x1f,
            0xe0, 0x91, 0xc5, 0xc7, 0x4c, 0x95, 0xa5, 0xdc, 0x04, 0x33, 0x90, 0x72, 0x3a, 0x4c, 0x12, 0x7d, 0xa1, 0x4c,
            0xdd, 0xe1, 0xdc, 0x26, 0x75, 0xa6, 0x23, 0x40, 0xb3, 0xe6, 0xaf, 0xd0, 0x52, 0x2a, 0x31, 0xde, 0x26, 0xe7,
            0xd1, 0xec, 0x3a, 0x9c, 0x8a, 0x09, 0x1f, 0xfd, 0xc7, 0x5b, 0x7e, 0xcf, 0xdc, 0x7c, 0x12, 0x99, 0x5a, 0x5e,
            0x37, 0xce, 0x34, 0x88, 0xbd, 0x29, 0xf8, 0x62, 0x9d, 0x68, 0xf6, 0x96, 0x49, 0x24, 0x48, 0xdd, 0x52, 0x66,
            0x97, 0x47, 0x6d, 0xc0, 0x61, 0x34, 0x6e, 0xbe, 0x3f, 0x67, 0x72, 0x17, 0xff, 0x9c, 0x60, 0xef, 0xce, 0x94,
            0x3a, 0xf2, 0x8d, 0xfd, 0x3f, 0x9e, 0x59, 0x69, 0x25, 0x98, 0xa6, 0x04, 0x7c, 0x23, 0xc4, 0xc0, 0x14, 0x00,
            0xf1, 0xab, 0x57, 0x30, 0xea, 0xc0, 0xae, 0x8d, 0x58, 0x43, 0xd5, 0x05, 0x1c, 0x37, 0x62, 0x40, 0x17, 0x2a,
            0xf2, 0x18, 0xd7, 0xa1, 0xec, 0xfe, 0x65, 0xb4, 0xf7, 0x51, 0x00, 0x63, 0x89, 0x83, 0xc1, 0x4d, 0xe4, 0x97,
            0x47, 0x55, 0xda, 0xde, 0x80, 0x18, 0xc9, 0xb8, 0xf4, 0x54, 0x3f, 0xb0, 0x95, 0x96, 0x15, 0x13, 0xe6, 0x7c,
            0x61, 0xdb, 0xc5, 0x9c, 0x60, 0x7f, 0x9b, 0x51, 0xf8, 0xd0, 0x9b, 0xdc, 0xad, 0x28, 0xbc, 0xfb, 0x9e, 0x5d,
            0x27, 0x44, 0xea, 0x88, 0x48, 0xb2, 0x62, 0x3a, 0xc0, 0x7f, 0x8e, 0xf6, 0x1a, 0x81, 0xa3, 0x59, 0x10, 0xb8,
            0xa1, 0xba, 0xf3, 0x9a, 0x91, 0x9a, 0x7b, 0x60, 0xbc, 0x60, 0x4d, 0x63, 0x18, 0x5f, 0x75, 0x92, 0x21, 0xd8,
            0x47, 0xcc, 0x54, 0xa2, 0x27, 0x65, 0xa4, 0xc3, 0x34, 0x75, 0xb5, 0x79, 0x1e, 0x9a, 0xf3, 0x27, 0x1f, 0xc8,
            0xd9, 0x35, 0x06, 0x67, 0x09, 0x0d, 0x81, 0x84, 0xec, 0x50, 0x52, 0x2d, 0x80, 0x4f, 0x23, 0xc4, 0xfb, 0x44,
            0xff, 0xa4, 0x81, 0xbc, 0x92, 0xae, 0x40, 0x8d, 0x1b, 0x9f, 0x2b, 0x13, 0x19, 0x04, 0xf9, 0x70, 0x5c, 0x59,
            0xe2, 0xf4, 0xbd, 0xe7, 0xa3, 0xb2, 0xc0, 0x85, 0xd9, 0x3f, 0xd2, 0xab, 0xc5, 0xe1, 0x4d, 0x16, 0x30, 0x01,
            0xa1, 0x2f, 0x51, 0x93, 0x8d, 0x02, 0x1a, 0xfa, 0x92, 0x23, 0x9b, 0x87, 0x3d, 0xc6, 0xc3, 0x57, 0xea, 0xa8,
            0xaf, 0x4e, 0xe6, 0xd0, 0x05, 0x40, 0x65, 0x7f, 0xe3, 0x29, 0x14, 0x10, 0x3b, 0x5d, 0x98, 0xf6, 0x8b, 0xd3,
            0xe2, 0xb5, 0x35, 0x9f, 0x08, 0xcc, 0xd8, 0x8d, 0x0c, 0x81, 0x1e, 0x4c, 0x31, 0xfb, 0xb4, 0x9f, 0x3a, 0x90,
            0xbb, 0xd0, 0x5d, 0xce, 0x62, 0xf3, 0x44, 0xe7, 0x07, 0x75, 0x93, 0x15, 0x9a, 0xe3, 0x50, 0x50, 0xb0, 0x4c,
            0x9e, 0x6b, 0x86, 0xbc, 0x43, 0x2d, 0xc8, 0xb0, 0x48, 0xc7, 0x3c, 0x00, 0x18, 0xca, 0x5b, 0x69, 0x41, 0x12,
            0x97, 0x73, 0x2a, 0x4e, 0x1a, 0xa9, 0x9a, 0x92, 0x8c, 0x71, 0xe7, 0xa2, 0x4f, 0xd2, 0x77, 0x85, 0x6a, 0xa4,
            0x25, 0x01, 0xe5, 0x1b, 0x01, 0x2a, 0xea, 0x94, 0x46, 0xa2, 0x10, 0x4e, 0x93, 0xf8, 0x15, 0xa0, 0xb3, 0xa2,
            0x9b, 0x45, 0x83, 0x14, 0xf3, 0xd8, 0xbe, 0x2b, 0x98, 0x23, 0xd3, 0x42, 0xf4, 0x62, 0x13, 0xe9, 0x42, 0xa7,
            0xe1, 0x9a, 0x46, 0xe9, 0x70, 0xb5, 0xc5, 0x06, 0x70, 0x84, 0x30, 0x31, 0x7b, 0x1b, 0xb3, 0xb3, 0x5d, 0xf6,
            0x8a, 0xe3, 0x3a, 0x49, 0x26, 0xa0, 0x3e, 0x6b, 0xfe, 0xb5, 0x51, 0x04, 0x16, 0xfc, 0xbb, 0x05, 0x24, 0xc9,
            0xca, 0x50, 0x74, 0x15, 0x6c, 0xc5, 0xa5, 0xd6, 0xfe, 0x1c, 0x99, 0x5e, 0xdc, 0x60, 0xa2, 0xf5, 0x50, 0x41,
            0x1a, 0xa4, 0x1e, 0x3d, 0xa3, 0xbd, 0xcf, 0x64, 0xbc, 0xf0, 0x4a, 0x05, 0x10, 0x57, 0x1b, 0x93, 0x6d, 0x47,
            0xe5, 0x5c, 0xec, 0x03, 0x30, 0x00, 0x8d, 0xfe, 0x73, 0x56, 0x34, 0x04, 0xf0, 0x47, 0xd7, 0xf3, 0xa8, 0xa3,
            0xd7, 0x74, 0x3b, 0xc5, 0x54, 0x95, 0x52, 0x10, 0xf1, 0xeb, 0x0d, 0x08, 0x59, 0x9e, 0xa7, 0x7d, 0x5f, 0x97,
            0x4d, 0x87, 0x17, 0x6d, 0x37, 0xd9, 0x8b, 0x9c, 0x0a, 0xd4, 0x40, 0x40, 0x72, 0x09, 0xed, 0x6a, 0x9f, 0x08,
            0x46, 0x4d, 0x56, 0x55, 0x93, 0xe1, 0xa6, 0x3b, 0x93, 0x85, 0x36, 0xb4, 0x92, 0x44, 0xe9, 0x7d,
        ];
        let script_code = vec![];
        let input_index = 1;
        let hash_type = 2;
        let amount = 652655344020909;
        let consensus_branch_id = 1991772603;
        let expected_sighash = H256::from([
            0xbb, 0xe6, 0xd8, 0x4f, 0x57, 0xc5, 0x6b, 0x29, 0xb9, 0x14, 0xc6, 0x94, 0xba, 0xac, 0xcb, 0x89, 0x12, 0x97,
            0xe9, 0x61, 0xde, 0x3e, 0xb4, 0x6c, 0x68, 0xe3, 0xc8, 0x9c, 0x47, 0xb1, 0xa1, 0xdb,
        ]);

        let tx: Transaction = deserialize(tx.as_slice()).unwrap();
        let mut signer = TransactionInputSigner::from(tx);
        signer.inputs[1].amount = amount;
        signer.consensus_branch_id = consensus_branch_id;

        let sig_hash = signer.signature_hash(
            input_index,
            amount,
            &script_code.into(),
            SignatureVersion::Base,
            hash_type,
        );

        assert_eq!(expected_sighash, sig_hash);
    }
}
